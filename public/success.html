<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="/theme.js"></script>
    <script src="/utm.js"></script>
    <link rel="stylesheet" href="/style.css" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-1021062139"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'AW-1021062139', { 'allow_enhanced_conversions': true });
    </script>
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "u4x90t35gk");
    </script>
    <title>Modelo de documento gerado | CartasApp</title>
</head>

<body>
    <div class="container">
        <div class="card">
            <h1 style="margin-bottom: 8px;">Modelo de documento gerado (ou em processamento)</h1>

            <p class="small" style="margin-bottom: 12px; color: var(--text-secondary);">
                Use esta p√°gina para acompanhar a confirma√ß√£o do pagamento e acessar o modelo do seu documento.
                A mensagem logo abaixo ser√° atualizada automaticamente pelo sistema.
            </p>

            <div class="small" style="margin-bottom: 12px; padding: 10px 12px; border-radius: 8px;
                        background: var(--bg-secondary); border: 1px solid var(--border);">
                <strong>Aviso importante:</strong>
                este √© um <strong>modelo de documento</strong> gerado automaticamente a partir
                das informa√ß√µes que voc√™ informou. O CartasApp n√£o presta assessoria jur√≠dica
                individual, n√£o analisa situa√ß√µes concretas de processos, guarda ou contratos
                e <strong>n√£o garante que o modelo ser√° aceito</strong> por √≥rg√£os p√∫blicos, cart√≥rios,
                empresas ou autoridades. A responsabilidade pela confer√™ncia do conte√∫do e pelo
                uso do documento √© exclusivamente do usu√°rio.
            </div>

            <div id="slug-warning" class="small" style="display:none; margin-bottom: 12px; padding: 10px 12px; border-radius: 8px;
                        background: var(--card-hover); border: 1px dashed var(--border);">
            </div>

            <p id="info" class="small" style="margin-bottom: 8px;"></p>

            <div id="retry" style="display:none; margin:10px 0; gap:8px; flex-wrap:wrap">
                <button class="btn" id="btnBack">Voltar ao formul√°rio</button>
                <button class="btn btn-outline" id="btnPay">Pagar agora</button>
            </div>

            <div id="doc-wrapper" style="display:none; margin-top:16px;">
                <div
                    style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
                    <div class="small"
                        style="font-weight:600; color:var(--text-primary); display:flex; align-items:center; gap:6px;">
                        <span>üìÑ Pr√©-visualiza√ß√£o do modelo</span>
                    </div>
                    <div class="small" style="color:var(--text-muted);">
                        Revise os dados abaixo. Depois, voc√™ pode ajustar o layout no arquivo Word se desejar.
                    </div>
                </div>

                <div
                    style="border-radius:12px; border:1px solid var(--border); background:var(--bg-secondary); padding:14px;">
                    <div id="doc" class="preview" data-clarity-mask="true" style="
                            background:#ffffff;
                            border-radius:10px;
                            padding:32px 40px;
                            max-height:520px;
                            overflow:auto;
                            box-shadow:0 10px 25px rgba(15,23,42,0.15);
                            font-family: 'Times New Roman', Georgia, 'serif';
                            font-size:14px;
                            line-height:1.7;
                            color:#111827;">
                    </div>
                </div>

                <p class="small" style="margin-top:8px; color:var(--text-muted);">
                    Esta √© apenas uma visualiza√ß√£o em texto. O arquivo final em <strong>Word/PDF</strong> ter√°
                    a mesma reda√ß√£o, pronto para impress√£o e assinatura.
                </p>
            </div>

            <div id="actions" style="display:none; gap:8px; margin-top:16px; flex-wrap:wrap; align-items:center;">
                <span class="small" style="color:var(--text-secondary); margin-right:8px;">
                    Salve o seu modelo:
                </span>
                <button class="btn" id="btnCopiar">Copiar texto</button>
                <button class="btn btn-outline" id="btnDoc">Baixar .DOC</button>
                <button class="btn btn-outline" id="btnPdf">Baixar .PDF</button>
                <button class="btn btn-outline" id="btnZap">Enviar no WhatsApp</button>
                <a class="btn btn-outline" id="btnSuporte" target="_blank" rel="noopener">
                    Falar no WhatsApp
                </a>
            </div>

            <div class="small" style="margin-top:24px; padding-top:16px; border-top:1px solid var(--border);">
                <strong>O que fazer agora?</strong>
                <ol style="margin:8px 0 0 18px; padding:0;">
                    <li>Assim que o texto aparecer acima, revise com aten√ß√£o se todos os dados est√£o corretos.</li>
                    <li>Use os bot√µes para <strong>baixar em Word/PDF</strong> e salvar em um lugar seguro.</li>
                    <li>Envie o documento por <strong>e-mail ou WhatsApp</strong> e, se necess√°rio, leve impresso
                        (cart√≥rio, empresa, companhia a√©rea, √≥rg√£o de tr√¢nsito, √≥rg√£o p√∫blico etc.).</li>
                    <li>Verifique sempre com a institui√ß√£o/autoridade respons√°vel (cart√≥rio, √≥rg√£o p√∫blico,
                        empresa, Pol√≠cia Federal, companhia a√©rea, juiz etc.) se o modelo atende √†s
                        <strong>exig√™ncias espec√≠ficas</strong> do seu caso antes de utilizar.
                    </li>
                </ol>
            </div>

            <div id="email-section"
                style="display:none; margin-top:24px; padding-top:24px; border-top: 1px solid var(--border);">
                <label class="label" style="margin-top:0;">Enviar por e-mail</label>
                <div style="display:flex; gap:8px;">
                    <input class="input" id="email-input" type="email" placeholder="digite_seu_email@exemplo.com"
                        style="flex:1;">
                    <button class="btn btn-secondary" id="email-button" style="padding-left:16px; padding-right:16px;">
                        Enviar
                    </button>
                </div>
                <p class="small" id="email-status" style="margin-top:8px;"></p>
            </div>

            <div id="nav-extra" style="display:none; gap:8px; margin-top:24px; padding-top:24px;
                        border-top: 1px solid var(--border); flex-wrap:wrap; align-items:center;">
                <a class="btn btn-primary" id="btnNovoDoc">Gerar Novo Documento</a>
                <a href="/" class="btn btn-outline">Voltar ao In√≠cio</a>
            </div>

            <p class="small" style="margin-top:8px;">
                Dica: salve uma c√≥pia em seu e-mail e leve o documento impresso se houver
                atendimento presencial (cart√≥rio, empresa, companhia a√©rea, √≥rg√£o p√∫blico etc.).
            </p>

            <div class="small" style="margin-top:16px; opacity:.9">
                Este site n√£o presta aconselhamento jur√≠dico individual, nem garante a aceita√ß√£o
                dos documentos gerados por √≥rg√£os p√∫blicos, cart√≥rios, empresas ou autoridades.
                Leia os <a href="/termos.html" style="text-decoration:underline">Termos de Uso</a>.
            </div>

            <div id="extra-docs" style="margin-top:32px; padding-top:24px; border-top:1px solid var(--border);">
                <h2 class="section-title" style="font-size:20px; margin-bottom:12px;">
                    Outros documentos que podem te ajudar
                </h2>

                <div style="display:grid; gap:12px;">
                    <a href="/viagem.html" data-doc="viagem" style="display:block; text-decoration:none; padding:12px 14px;
                             border-radius:12px; border:1px solid var(--border);
                             background:var(--bg-secondary);">
                        <div class="small" style="font-weight:600; margin-bottom:4px;">
                            Autoriza√ß√£o de Viagem para Menor
                        </div>
                        <div class="small" style="color:var(--text-secondary);">
                            Modelo de autoriza√ß√£o baseado nas orienta√ß√µes da Pol√≠cia Federal e do CNJ,
                            para imprimir, assinar e reconhecer firma. A aceita√ß√£o do documento depende
                            das autoridades respons√°veis pela viagem.
                        </div>
                    </a>

                    <a href="/multa.html" data-doc="multa" style="display:block; text-decoration:none; padding:12px 14px;
                             border-radius:12px; border:1px solid var(--border);
                             background:var(--bg-secondary);">
                        <div class="small" style="font-weight:600; margin-bottom:4px;">
                            Recurso de Multa de Tr√¢nsito
                        </div>
                        <div class="small" style="color:var(--text-secondary);">
                            Gere um modelo de recurso personalizado com base na sua situa√ß√£o
                            para apresentar ao √≥rg√£o de tr√¢nsito.
                        </div>
                    </a>

                    <a href="/reembolso-cancelamento-passagem.html" data-doc="reembolso" style="display:block; text-decoration:none; padding:12px 14px;
                             border-radius:12px; border:1px solid var(--border);
                             background:var(--bg-secondary);">
                        <div class="small" style="font-weight:600; margin-bottom:4px;">
                            Reembolso de Passagem A√©rea
                        </div>
                        <div class="small" style="color:var(--text-secondary);">
                            Carta-modelo para pedir reembolso quando a companhia desconta mais
                            do que o permitido, para voc√™ adaptar ao seu caso.
                        </div>
                    </a>

                    <a href="/bagagem.html" data-doc="bagagem" style="display:block; text-decoration:none; padding:12px 14px;
                             border-radius:12px; border:1px solid var(--border);
                             background:var(--bg-secondary);">
                        <div class="small" style="font-weight:600; margin-bottom:4px;">
                            Reclama√ß√£o de Bagagem Extraviada ou Danificada
                        </div>
                        <div class="small" style="color:var(--text-secondary);">
                            Modelo de reclama√ß√£o para companhias a√©reas em caso de
                            extravio, dano ou atraso na entrega da bagagem.
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <p>
                    Este site n√£o presta aconselhamento jur√≠dico. Leia os
                    <a href="/termos.html" class="footer-link">Termos de Uso</a>,
                    <a href="/privacidade.html" class="footer-link">Pol√≠tica de Privacidade</a>,
                    conhe√ßa mais em
                    <a href="/sobre.html" class="footer-link">Sobre o CartasApp</a>
                    e visite nossa
                    <a href="/blog.html" class="footer-link">Central de Ajuda</a>.
                </p>
            </div>
        </div>
    </footer>

    <script src="/recovery.js"></script>
    <script>
        var SEND_TO_CONVERSAO = 'AW-1021062139/eWBbCPil_7kbEPvX8OYD';
        function qs(n) { var u = new URL(location.href); return u.searchParams.get(n); }
        var orderId = qs('o');
        var slug = qs('slug');
        var s = qs('s');

        // aviso espec√≠fico por tipo de documento
        (function () {
            var box = document.getElementById('slug-warning');
            if (!box) return;
            var sl = (slug || '').toLowerCase();

            if (sl.indexOf('viagem') > -1) {
                box.style.display = 'block';
                box.innerHTML =
                    '<strong>Se este documento for uma autoriza√ß√£o de viagem para menor:</strong>' +
                    '<ul style="margin:6px 0 0 18px; padding:0; list-style:disc;">' +
                    '<li>trata-se apenas de um <strong>modelo de autoriza√ß√£o</strong>; revise todo o texto antes de assinar ou reconhecer firma;</li>' +
                    '<li>para viagens nacionais, em regra √© exigida autoriza√ß√£o com firma reconhecida, mas companhias a√©reas/rodovi√°rias podem impor regras adicionais;</li>' +
                    '<li>para viagens internacionais, podem ser exigidos documentos complementares, como autoriza√ß√£o em formul√°rio pr√≥prio, tradu√ß√£o/bil√≠ngue, passaporte v√°lido e at√© <strong>autoriza√ß√£o judicial espec√≠fica</strong> ‚Äî confirme sempre com a Pol√≠cia Federal, a companhia a√©rea e o consulado do pa√≠s de destino;</li>' +
                    '<li>em situa√ß√µes de guarda, disputa entre os pais ou d√∫vidas jur√≠dicas, procure a Vara da Inf√¢ncia e Juventude ou um advogado.</li>' +
                    '</ul>';
            }
        })();

        var info = document.getElementById('info');
        var retry = document.getElementById('retry');
        var btnBack = document.getElementById('btnBack');
        var btnPay = document.getElementById('btnPay');
        var docBox = document.getElementById('doc');
        var docWrapper = document.getElementById('doc-wrapper');
        var actions = document.getElementById('actions');
        var btnCopiar = document.getElementById('btnCopiar');
        var btnDoc = document.getElementById('btnDoc');
        var btnPdf = document.getElementById('btnPdf');
        var btnZap = document.getElementById('btnZap');
        var btnSuporte = document.getElementById('btnSuporte');
        var navExtra = document.getElementById('nav-extra');
        var btnNovoDoc = document.getElementById('btnNovoDoc');
        var emailSection = document.getElementById('email-section');
        var emailInput = document.getElementById('email-input');
        var emailButton = document.getElementById('email-button');
        var emailStatus = document.getElementById('email-status');

        function getOrderStatus() { return fetch('/.netlify/functions/order-status?o=' + encodeURIComponent(orderId)).then(function (r) { return r.ok ? r.json() : null; }); }

        // --- L√ìGICA DE ROTEAMENTO CORRIGIDA (BTN VOLTAR) ---
        function getPageUrl(slugStr) {
            var s = (slugStr || '').toLowerCase();
            if (s.indexOf('multa') > -1) return '/multa.html';
            if (s.indexOf('viagem') > -1) return '/viagem.html';
            if (s.indexOf('bagagem') > -1) return '/bagagem.html'; // Serve para extraviada e danificada
            if (s.indexOf('reembolso') > -1) return '/reembolso-cancelamento-passagem.html';
            if (s.indexOf('ecommerce') > -1) return '/ecommerce.html';

            // Padr√£o (Smart Fit, Bancos, etc)
            if (slugStr) return '/doc.html?slug=' + encodeURIComponent(slugStr);
            return '/';
        }

        btnBack.onclick = function () {
            location.href = getPageUrl(slug);
        };

        btnPay.onclick = async function () { var payloadStr = localStorage.getItem('pendingPayload'); if (!payloadStr) { btnBack.onclick(); return; } try { var p = JSON.parse(payloadStr); var r = await fetch('/.netlify/functions/mp-checkout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ slug: p.slug || slug || 'documento', utm: p.utm || {} }) }); var data = await r.json(); if (r.ok && data.init_point) location.href = data.init_point; } catch (e) { } };

        function renderDocText(out) { var partes = []; if (out.saudacao) partes.push(out.saudacao); var body = out.corpo_paragrafos || []; for (var i = 0; i < body.length; i++) partes.push(body[i]); if (out.fechamento) partes.push(out.fechamento); return partes.join('\n\n'); }
        function htmlBodyFromText(t) { return t.split('\n\n').map(function (p) { return '<p>' + p.replace(/\n/g, '<br/>') + '</p>'; }).join(''); }
        function onceConv(id) { try { var k = 'c:' + id; if (localStorage.getItem(k)) return false; localStorage.setItem(k, '1'); return true; } catch (e) { return true; } }
        function normalizeEmail(v) { if (!v) return ''; return String(v).trim().toLowerCase(); }
        function normalizePhone(v) { if (!v) return ''; var d = String(v).replace(/\D/g, ''); if (d.indexOf('55') !== 0) d = '55' + d; return d; }
        async function sha256Hex(s) { if (!s) return ''; var enc = new TextEncoder().encode(s); var buf = await crypto.subtle.digest('SHA-256', enc); var a = Array.from(new Uint8Array(buf)); return a.map(function (b) { return b.toString(16).padStart(2, '0'); }).join(''); }
        async function buildECData() { try { var p = JSON.parse(localStorage.getItem('pendingPayload') || '{}'); var em = normalizeEmail(p.email); var ph = normalizePhone(p.telefone); var ec = {}; if (em) ec.email = await sha256Hex(em); if (ph) ec.phone_number = await sha256Hex(ph); ec.address = { country: 'BR' }; return ec; } catch (e) { return { address: { country: 'BR' } }; } }

        function attachActions(fullText, payload) {
            var bodyHtml = htmlBodyFromText(fullText);

            // -------------------------------------------------------
            // 1. L√ìGICA DO NOME DO ARQUIVO BONITO (SEM ACENTOS)
            // -------------------------------------------------------
            var filename = 'CartasApp_Documento'; // Nome padr√£o

            if (payload) {
                // Fun√ß√£o para limpar string (sem acentos e sem espa√ßos)
                function sanitizeName(str) {
                    if (!str) return '';
                    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Remove acentos
                        .replace(/[^a-zA-Z0-9 ]/g, "") // Remove s√≠mbolos estranhos
                        .trim()
                        .replace(/\s+/g, "_"); // Troca espa√ßos por _
                }

                if (payload.menor_nome) {
                    // Ex: Autorizacao_Viagem_Enzo_Gabriel
                    filename = 'Autorizacao_Viagem_' + sanitizeName(payload.menor_nome);
                }
                else if (payload.placa) {
                    // Ex: Recurso_Multa_ABC1234
                    filename = 'Recurso_Multa_' + sanitizeName(payload.placa);
                }
                else if (payload.nome) {
                    // Ex: Documento_Joao_Silva
                    filename = 'Documento_' + sanitizeName(payload.nome);
                }
            }
            // -------------------------------------------------------

            btnCopiar.onclick = async function () { try { await navigator.clipboard.writeText(fullText); btnCopiar.textContent = 'Copiado!'; setTimeout(function () { btnCopiar.textContent = 'Copiar texto'; }, 1200); } catch (e) { } };

            // Aqui passamos o "filename" din√¢mico para as fun√ß√µes de download
            btnDoc.onclick = function () { LMRecovery.doc(bodyHtml, filename); };
            btnPdf.onclick = function () { LMRecovery.pdf(bodyHtml, filename); };

            btnZap.onclick = function () { var url = 'https://api.whatsapp.com/send?text=' + encodeURIComponent(fullText); window.open(url, '_blank'); };
            btnSuporte.href = 'https://wa.me/5547988616874?text=' + encodeURIComponent('Oi! Preciso de ajuda. Pedido: ' + (orderId || '') + ' | Tipo: ' + (payload && payload.tipo || slug || ''));

            // Salvamos tamb√©m no hist√≥rico com o nome correto
            LMRecovery.saveGeneratedDoc({ html: bodyHtml, payload: payload || null, meta: { type: (payload && payload.tipo) || slug || '', orderId: orderId || '', filename: filename } });

            localStorage.removeItem('pendingPayload');

            if (btnNovoDoc) {
                btnNovoDoc.href = getPageUrl(slug);
            }

            if (navExtra) navExtra.style.display = 'flex';

            if (emailSection) emailSection.style.display = 'block';
            if (payload && payload.email) {
                emailInput.value = payload.email;
            }

            emailButton.onclick = async function () {
                var email = emailInput.value.trim();
                if (!email || !email.includes('@') || email.length < 5) {
                    emailStatus.textContent = 'Por favor, digite um e-mail v√°lido.';
                    emailStatus.style.color = 'var(--accent-error)';
                    return;
                }

                emailButton.disabled = true;
                emailButton.textContent = 'Enviando...';
                emailStatus.textContent = 'Preparando o envio...';
                emailStatus.style.color = 'var(--text-muted)';

                try {
                    var rs = await fetch('/.netlify/functions/send-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            order_id: orderId,
                            email_to: email
                        })
                    });
                    if (!rs.ok) { throw new Error('Falha no servidor'); }

                    emailStatus.textContent = 'E-mail enviado com sucesso para ' + email + '!';
                    emailStatus.style.color = 'var(--accent-success)';

                } catch (e) {
                    emailStatus.textContent = 'Houve um erro ao enviar. Tente novamente.';
                    emailStatus.style.color = 'var(--accent-error)';
                }

                let countdown = 60;
                emailButton.textContent = `Aguarde ${countdown}s`;

                var interval = setInterval(function () {
                    countdown--;
                    if (countdown > 0) {
                        emailButton.textContent = `Aguarde ${countdown}s`;
                    } else {
                        clearInterval(interval);
                        emailButton.textContent = 'Enviar';
                        emailButton.disabled = false;
                    }
                }, 1000);
            };
        }

        // --- FUN√á√ÉO DE EXIBI√á√ÉO PREMIUM (SUBSTITUA A ANTIGA showDocAndScroll) ---
        function showDocAndScroll(fullText, payload) {
            // Se tiver o elemento docBox, injetamos o HTML bonito
            if (docBox) {
                // Tenta detectar o t√≠tulo dinamicamente (Nacional vs Internacional)
                var tituloDoc = "AUTORIZA√á√ÉO DE VIAGEM";
                var textoLower = fullText.toLowerCase();

                if (textoLower.includes("viagem internacional")) tituloDoc += " INTERNACIONAL";
                else if (textoLower.includes("viagem nacional")) tituloDoc += " NACIONAL";
                // Se n√£o for viagem (ex: outros tipos), tenta inferir ou usa gen√©rico
                else if (textoLower.includes("multa") || textoLower.includes("recurso")) tituloDoc = "RECURSO DE MULTA";
                else if (textoLower.includes("reembolso")) tituloDoc = "SOLICITA√á√ÉO DE REEMBOLSO";
                else if (textoLower.includes("bagagem")) tituloDoc = "RECLAMA√á√ÉO DE BAGAGEM";

                var htmlBonito = `
                    <div style="text-align:center; border-bottom:2px solid #000; padding-bottom:15px; margin-bottom:25px;">
                        <div style="font-size:32px; margin-bottom:5px;">‚öñÔ∏è</div>
                        <h2 style="font-family:'Times New Roman',serif; text-transform:uppercase; margin:0; font-size:18px; color:#000;">${tituloDoc}</h2>
                        <p style="font-family:Arial,sans-serif; font-size:11px; margin:5px 0 0 0; color:#555;">
                            Conforme legisla√ß√£o vigente e resolu√ß√µes aplic√°veis
                        </p>
                    </div>

                    <div style="font-family:'Times New Roman',serif; font-size:15px; line-height:1.6; text-align:justify; color:#000;">
                        ${fullText.replace(/\n/g, '<br>')}
                    </div>

                    <div style="margin-top:40px; border-top:1px dashed #999; padding-top:10px; text-align:center; font-family:Arial,sans-serif; font-size:10px; color:#777;">
                        Documento gerado oficialmente via <strong>CartasApp.com.br</strong><br>
                        V√°lido mediante assinatura e reconhecimento de firma (se aplic√°vel).
                    </div>
                `;

                docBox.innerHTML = htmlBonito;

                // Estiliza a caixa para parecer uma folha de papel
                docBox.style.backgroundColor = "#fff";
                docBox.style.padding = "40px"; // Margem interna generosa
                docBox.style.border = "1px solid #ccc";
                docBox.style.borderRadius = "2px";
                docBox.style.boxShadow = "0 5px 15px rgba(0,0,0,0.1)";
            }

            if (docWrapper) {
                docWrapper.style.display = 'block';
                // scroll suave at√© a pr√©via ‚Äî ajuda muito no celular
                setTimeout(function () {
                    docWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 150);
            }

            if (actions) actions.style.display = 'flex';

            if (info) {
                info.textContent = 'Documento gerado com sucesso! Baixe seu PDF abaixo.';
            }

            attachActions(fullText, payload || null);
        }

        async function gerarFinalIdempotente() {
            // TENTA RECUPERAR O PAYLOAD LOCAL PARA GARANTIR O NOME CORRETO
            var localPayload = null;
            try {
                var saved = localStorage.getItem('pendingPayload');
                if (saved) localPayload = JSON.parse(saved);
            } catch (e) { }

            try {
                if (info) info.textContent = 'Gerando seu documento...';

                if (orderId) {
                    for (var i = 0; i < 5; i++) {
                        try {
                            var rs = await fetch('/.netlify/functions/generate-doc', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ payload: { order_id: orderId }, preview: false })
                            });

                            if (rs.ok) {
                                var js = await rs.json();
                                if (js && js.output) {
                                    var fullTextS = renderDocText(js.output, null);
                                    // AQUI ESTAVA O ERRO: passava null, agora passa localPayload
                                    showDocAndScroll(fullTextS, localPayload);
                                    return;
                                }
                            }
                        } catch (e) { }
                        await new Promise(function (r) { setTimeout(r, 1500); });
                    }
                }

                // Se n√£o achou pelo OrderID ou n√£o tinha OrderID, segue fluxo normal
                if (!localPayload) {
                    // Caso extremo: n√£o achou nem local nem remoto
                    // Tenta carregar do storage de novo
                    var payloadStr = localStorage.getItem('pendingPayload');
                    if (payloadStr) localPayload = JSON.parse(payloadStr);
                }

                if (!localPayload) {
                    if (info) info.textContent = 'Pagamento confirmado. Ainda estamos preparando seu documento. Aguarde alguns instantes e n√£o feche esta p√°gina.';
                    for (var j = 0; j < 5; j++) {
                        try {
                            var rs2 = await fetch('/.netlify/functions/generate-doc', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ payload: { order_id: orderId }, preview: false })
                            });

                            if (rs2.ok) {
                                var js2 = await rs2.json();
                                if (js2 && js2.output) {
                                    var fullTextS2 = renderDocText(js2.output, null);
                                    showDocAndScroll(fullTextS2, null);
                                    return;
                                }
                            }
                        } catch (e) { }
                        await new Promise(function (r) { setTimeout(r, 1500); });
                    }
                    if (retry) retry.style.display = 'flex';
                    return;
                }

                var payload = localPayload;
                payload.order_id = orderId || null;

                var r = await fetch('/.netlify/functions/generate-doc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payload: payload, preview: false })
                });
                var data = await r.json();
                var out = data.output || data;

                var fullText = renderDocText(out, payload);
                showDocAndScroll(fullText, payload);

            } catch (e) {
                if (info) info.textContent = 'Falha ao preparar o documento. Tente novamente em instantes.';
                if (retry) retry.style.display = 'flex';
            }
        }

        async function sendConversionEC() {
            var ec = await buildECData();
            gtag('event', 'conversion', {
                send_to: SEND_TO_CONVERSAO,
                value: 9.9,
                currency: 'BRL',
                transaction_id: orderId,
                user_data: ec
            });
        }

        async function flow() {
            if (s === 'failure') {
                info.textContent = 'Pagamento n√£o conclu√≠do. Voc√™ pode voltar ao documento ou tentar pagar novamente.';
                retry.style.display = 'flex';
                return;
            }
            info.textContent = 'Confirmando pagamento (pode levar alguns segundos com Pix)...';
            if (!orderId) {
                info.textContent = 'N√£o conseguimos identificar o pedido. Clique em Voltar.';
                retry.style.display = 'flex';
                return;
            }
            var start = Date.now();
            while (Date.now() - start < 60000) {
                var st = await getOrderStatus().catch(function () { return null; });
                if (st && st.status === 'paid') {
                    if (onceConv(orderId)) {
                        await sendConversionEC();
                    }
                    info.textContent = 'Pagamento confirmado. Gerando seu documento...';
                    await gerarFinalIdempotente();
                    return;
                }
                await new Promise(function (r) { setTimeout(r, 2000); });
            }
            info.textContent = 'Ainda n√£o conseguimos confirmar. Se voc√™ j√° pagou, aguarde alguns instantes; ou tente pagar novamente.';
            retry.style.display = 'flex';
        }
        flow();
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            try {
                var s = (window.slug || '').toLowerCase();
                var cards = document.querySelectorAll('#extra-docs a[data-doc]');
                if (!cards.length) return;

                function hide(docType) {
                    cards.forEach(function (c) {
                        if (c.getAttribute('data-doc') === docType) {
                            c.style.display = 'none';
                        }
                    });
                }

                function prioritize(order) {
                    var container = document.querySelector('#extra-docs > div');
                    if (!container) return;
                    order.forEach(function (docType) {
                        cards.forEach(function (c) {
                            if (c.getAttribute('data-doc') === docType) {
                                container.prepend(c);
                            }
                        });
                    });
                }

                if (s.indexOf('viagem') > -1) {
                    // Comprou AUTORIZA√á√ÉO DE VIAGEM
                    hide('viagem');
                    prioritize(['reembolso', 'bagagem', 'multa']);
                } else if (s.indexOf('reembolso') > -1) {
                    // Comprou REEMBOLSO DE PASSAGEM
                    hide('reembolso');
                    prioritize(['bagagem', 'viagem', 'multa']);
                } else if (s.indexOf('bagagem') > -1) {
                    // Comprou BAGAGEM
                    hide('bagagem');
                    prioritize(['reembolso', 'viagem', 'multa']);
                } else if (s.indexOf('multa') > -1) {
                    // Comprou RECURSO DE MULTA
                    hide('multa');
                    prioritize(['reembolso', 'bagagem', 'viagem']);
                } else {
                    // Outros tipos (academias, servi√ßos etc.)
                    prioritize(['reembolso', 'multa', 'bagagem', 'viagem']);
                }
            } catch (e) {
                console.error('Upsell error', e);
            }
        });
    </script>
</body>

</html>