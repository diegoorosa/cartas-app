<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="/theme.js"></script>
    <script src="/utm.js"></script>
    <link rel="stylesheet" href="/style.css" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-1021062139"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'AW-1021062139', { 'allow_enhanced_conversions': true });
    </script>
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "u4x90t35gk");
    </script>
    <title>Documento pronto</title>
</head>

<body>
    <div class="container">
        <div class="card">
            <h1 style="margin-bottom: 8px;">Documento gerado (ou em processamento)</h1>

            <p class="small" style="margin-bottom: 12px; color: var(--text-secondary);">
                Use esta página para acompanhar a confirmação do pagamento e acessar o seu documento.
                A mensagem logo abaixo será atualizada automaticamente pelo sistema.
            </p>

            <!-- mensagem dinâmica controlada pelo JS -->
            <p id="info" class="small" style="margin-bottom: 8px;"></p>

            <!-- bloco mostrado quando o pagamento não foi concluído -->
            <div id="retry"
                 style="display:none; margin:10px 0; gap:8px; flex-wrap:wrap">
                <button class="btn" id="btnBack">Voltar ao formulário</button>
                <button class="btn btn-outline" id="btnPay">Pagar agora</button>
            </div>

            <!-- texto completo do documento -->
            <div id="doc" class="preview" style="display:none" data-clarity-mask="true"></div>

            <!-- botões de ação sobre o documento -->
            <div id="actions"
                 style="display:none; gap:8px; margin-top:12px; flex-wrap:wrap">
                <button class="btn" id="btnCopiar">Copiar</button>
                <button class="btn btn-outline" id="btnDoc">Baixar .DOC</button>
                <button class="btn btn-outline" id="btnPdf">Baixar .PDF</button>
                <button class="btn btn-outline" id="btnZap">Enviar no WhatsApp</button>
                <a class="btn btn-outline" id="btnSuporte" target="_blank" rel="noopener">
                    Falar no WhatsApp
                </a>
            </div>

            <!-- próximos passos / instruções genéricas -->
            <div class="small"
                 style="margin-top:24px; padding-top:16px; border-top:1px solid var(--border);">
                <strong>O que fazer agora?</strong>
                <ol style="margin:8px 0 0 18px; padding:0;">
                    <li>Assim que o texto aparecer acima, revise se todos os dados estão corretos.</li>
                    <li>Use os botões para <strong>baixar em Word/PDF</strong> e salvar em um lugar seguro.</li>
                    <li>Envie o documento por <strong>e-mail ou WhatsApp</strong> e, se necessário, leve impresso
                        (cartório, empresa, companhia aérea, órgão de trânsito etc.).</li>
                </ol>
            </div>

            <!-- envio por e-mail -->
            <div id="email-section"
                 style="display:none; margin-top:24px; padding-top:24px; border-top: 1px solid var(--border);">
                <label class="label" style="margin-top:0;">Enviar por e-mail</label>
                <div style="display:flex; gap:8px;">
                    <input class="input" id="email-input" type="email"
                           placeholder="digite_seu_email@exemplo.com"
                           style="flex:1;">
                    <button class="btn btn-secondary" id="email-button"
                            style="padding-left:16px; padding-right:16px;">
                        Enviar
                    </button>
                </div>
                <p class="small" id="email-status" style="margin-top:8px;"></p>
            </div>

            <!-- navegação extra -->
            <div id="nav-extra"
                 style="display:none; gap:8px; margin-top:24px; padding-top:24px;
                        border-top: 1px solid var(--border); flex-wrap:wrap">
                <a class="btn btn-primary" id="btnNovoDoc">Gerar Novo Documento</a>
                <a href="/" class="btn btn-outline">Voltar ao Início</a>
            </div>

            <!-- dica rápida -->
            <p class="small" style="margin-top:8px;">
                Dica: salve uma cópia em seu e-mail e leve o documento impresso se houver
                atendimento presencial (cartório, empresa, companhia aérea, órgão público etc.).
            </p>

            <!-- mini disclaimer interno -->
            <div class="small" style="margin-top:16px; opacity:.9">
                Este site não presta aconselhamento jurídico. Leia os
                <a href="/termos.html" style="text-decoration:underline">Termos de Uso</a>.
            </div>

            <!-- seção de outros documentos sugeridos (upsell genérico) -->
            <div id="extra-docs"
                 style="margin-top:32px; padding-top:24px; border-top:1px solid var(--border);">
                <h2 class="section-title"
                    style="font-size:20px; margin-bottom:12px;">
                    Outros documentos que podem te ajudar
                </h2>

                <div style="display:grid; gap:12px;">
                    <a href="/viagem.html"
                       data-doc="viagem"
                       style="display:block; text-decoration:none; padding:12px 14px;
                              border-radius:12px; border:1px solid var(--border);
                              background:var(--bg-secondary);">
                        <div class="small" style="font-weight:600; margin-bottom:4px;">
                            Autorização de Viagem para Menor
                        </div>
                        <div class="small" style="color:var(--text-secondary);">
                            Modelo alinhado às exigências da Polícia Federal / CNJ, pronto para
                            imprimir e reconhecer firma.
                        </div>
                    </a>

                    <a href="/multa.html"
                       data-doc="multa"
                       style="display:block; text-decoration:none; padding:12px 14px;
                              border-radius:12px; border:1px solid var(--border);
                              background:var(--bg-secondary);">
                        <div class="small" style="font-weight:600; margin-bottom:4px;">
                            Recurso de Multa de Trânsito
                        </div>
                        <div class="small" style="color:var(--text-secondary);">
                            Gere um recurso personalizado com base na sua situação para tentar
                            evitar pontos e valores indevidos.
                        </div>
                    </a>

                    <a href="/reembolso-cancelamento-passagem.html"
                       data-doc="reembolso"
                       style="display:block; text-decoration:none; padding:12px 14px;
                              border-radius:12px; border:1px solid var(--border);
                              background:var(--bg-secondary);">
                        <div class="small" style="font-weight:600; margin-bottom:4px;">
                            Reembolso de Passagem Aérea
                        </div>
                        <div class="small" style="color:var(--text-secondary);">
                            Carta para pedir reembolso quando a companhia desconta mais do que
                            os 5% previstos em lei.
                        </div>
                    </a>

                    <a href="/bagagem.html"
                       data-doc="bagagem"
                       style="display:block; text-decoration:none; padding:12px 14px;
                              border-radius:12px; border:1px solid var(--border);
                              background:var(--bg-secondary);">
                        <div class="small" style="font-weight:600; margin-bottom:4px;">
                            Reclamação de Bagagem Extraviada ou Danificada
                        </div>
                        <div class="small" style="color:var(--text-secondary);">
                            Modelo de reclamação para companhias aéreas em caso de
                            extravio, dano ou atraso na entrega da bagagem.
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
    <div class="container">
        <div class="footer-content">
            <p>
                Este site não presta aconselhamento jurídico. Leia os
                <a href="/termos.html" class="footer-link">Termos de Uso</a>,
                <a href="/privacidade.html" class="footer-link">Política de Privacidade</a>,
                conheça mais em
                <a href="/sobre.html" class="footer-link">Sobre o CartasApp</a>
                e visite nossa
                <a href="/blog.html" class="footer-link">Central de Ajuda</a>.
            </p>
        </div>
    </div>
</footer>

    <script src="/recovery.js"></script>
    <script>
        var SEND_TO_CONVERSAO = 'AW-1021062139/eWBbCPil_7kbEPvX8OYD';
        function qs(n) { var u = new URL(location.href); return u.searchParams.get(n); }
        var orderId = qs('o');
        var slug = qs('slug');
        var s = qs('s');
        var info = document.getElementById('info');
        var retry = document.getElementById('retry');
        var btnBack = document.getElementById('btnBack');
        var btnPay = document.getElementById('btnPay');
        var docBox = document.getElementById('doc');
        var actions = document.getElementById('actions');
        var btnCopiar = document.getElementById('btnCopiar');
        var btnDoc = document.getElementById('btnDoc');
        var btnPdf = document.getElementById('btnPdf');
        var btnZap = document.getElementById('btnZap');
        var btnSuporte = document.getElementById('btnSuporte');
        var navExtra = document.getElementById('nav-extra');
        var btnNovoDoc = document.getElementById('btnNovoDoc');
        var emailSection = document.getElementById('email-section');
        var emailInput = document.getElementById('email-input');
        var emailButton = document.getElementById('email-button');
        var emailStatus = document.getElementById('email-status');

        function getOrderStatus() { return fetch('/.netlify/functions/order-status?o=' + encodeURIComponent(orderId)).then(function (r) { return r.ok ? r.json() : null; }); }

        // --- LÓGICA DE ROTEAMENTO CORRIGIDA (BTN VOLTAR) ---
        function getPageUrl(slugStr) {
            var s = (slugStr || '').toLowerCase();
            if (s.indexOf('multa') > -1) return '/multa.html';
            if (s.indexOf('viagem') > -1) return '/viagem.html';
            if (s.indexOf('bagagem') > -1) return '/bagagem.html'; // Serve para extraviada e danificada
            if (s.indexOf('reembolso') > -1) return '/reembolso-cancelamento-passagem.html';
            if (s.indexOf('ecommerce') > -1) return '/ecommerce.html';

            // Padrão (Smart Fit, Bancos, etc)
            if (slugStr) return '/doc.html?slug=' + encodeURIComponent(slugStr);
            return '/';
        }

        btnBack.onclick = function () {
            location.href = getPageUrl(slug);
        };

        btnPay.onclick = async function () { var payloadStr = localStorage.getItem('pendingPayload'); if (!payloadStr) { btnBack.onclick(); return; } try { var p = JSON.parse(payloadStr); var r = await fetch('/.netlify/functions/mp-checkout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ slug: p.slug || slug || 'documento', utm: p.utm || {} }) }); var data = await r.json(); if (r.ok && data.init_point) location.href = data.init_point; } catch (e) { } };

        function renderDocText(out) { var partes = []; if (out.saudacao) partes.push(out.saudacao); var body = out.corpo_paragrafos || []; for (var i = 0; i < body.length; i++) partes.push(body[i]); if (out.fechamento) partes.push(out.fechamento); return partes.join('\n\n'); }
        function htmlBodyFromText(t) { return t.split('\n\n').map(function (p) { return '<p>' + p.replace(/\n/g, '<br/>') + '</p>'; }).join(''); }
        function onceConv(id) { try { var k = 'c:' + id; if (localStorage.getItem(k)) return false; localStorage.setItem(k, '1'); return true; } catch (e) { return true; } }
        function normalizeEmail(v) { if (!v) return ''; return String(v).trim().toLowerCase(); }
        function normalizePhone(v) { if (!v) return ''; var d = String(v).replace(/\D/g, ''); if (d.indexOf('55') !== 0) d = '55' + d; return d; }
        async function sha256Hex(s) { if (!s) return ''; var enc = new TextEncoder().encode(s); var buf = await crypto.subtle.digest('SHA-256', enc); var a = Array.from(new Uint8Array(buf)); return a.map(function (b) { return b.toString(16).padStart(2, '0'); }).join(''); }
        async function buildECData() { try { var p = JSON.parse(localStorage.getItem('pendingPayload') || '{}'); var em = normalizeEmail(p.email); var ph = normalizePhone(p.telefone); var ec = {}; if (em) ec.email = await sha256Hex(em); if (ph) ec.phone_number = await sha256Hex(ph); ec.address = { country: 'BR' }; return ec; } catch (e) { return { address: { country: 'BR' } }; } }

        function attachActions(fullText, payload) {
            var bodyHtml = htmlBodyFromText(fullText);
            btnCopiar.onclick = async function () { try { await navigator.clipboard.writeText(fullText); btnCopiar.textContent = 'Copiado!'; setTimeout(function () { btnCopiar.textContent = 'Copiar'; }, 1200); } catch (e) { } };
            btnDoc.onclick = function () { LMRecovery.doc(bodyHtml, 'documento'); };
            btnPdf.onclick = function () { LMRecovery.pdf(bodyHtml, 'documento'); };
            btnZap.onclick = function () { var url = 'https://api.whatsapp.com/send?text=' + encodeURIComponent(fullText); window.open(url, '_blank'); };
            btnSuporte.href = 'https://wa.me/5547988616874?text=' + encodeURIComponent('Oi! Preciso de ajuda. Pedido: ' + (orderId || '') + ' | Tipo: ' + (payload && payload.tipo || slug || ''));
            LMRecovery.saveGeneratedDoc({ html: bodyHtml, payload: payload || null, meta: { type: (payload && payload.tipo) || slug || '', orderId: orderId || '', filename: 'documento' } });
            localStorage.removeItem('pendingPayload');

            // --- CORREÇÃO DO BOTÃO "GERAR NOVO DOCUMENTO" ---
            if (btnNovoDoc) {
                btnNovoDoc.href = getPageUrl(slug);
            }
            // -----------------------------------------------

            if (navExtra) navExtra.style.display = 'flex';

            if (emailSection) emailSection.style.display = 'block';
            if (payload && payload.email) {
                emailInput.value = payload.email;
            }

            emailButton.onclick = async function () {
                var email = emailInput.value.trim();
                if (!email || !email.includes('@') || email.length < 5) {
                    emailStatus.textContent = 'Por favor, digite um e-mail válido.';
                    emailStatus.style.color = 'var(--accent-error)';
                    return;
                }

                emailButton.disabled = true;
                emailButton.textContent = 'Enviando...';
                emailStatus.textContent = 'Preparando o envio...';
                emailStatus.style.color = 'var(--text-muted)';

                try {
                    var rs = await fetch('/.netlify/functions/send-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            order_id: orderId,
                            email_to: email
                        })
                    });
                    if (!rs.ok) { throw new Error('Falha no servidor'); }

                    emailStatus.textContent = 'E-mail enviado com sucesso para ' + email + '!';
                    emailStatus.style.color = 'var(--accent-success)';

                } catch (e) {
                    emailStatus.textContent = 'Houve um erro ao enviar. Tente novamente.';
                    emailStatus.style.color = 'var(--accent-error)';
                }

                let countdown = 60;
                emailButton.textContent = `Aguarde ${countdown}s`;

                var interval = setInterval(function () {
                    countdown--;
                    if (countdown > 0) {
                        emailButton.textContent = `Aguarde ${countdown}s`;
                    } else {
                        clearInterval(interval);
                        emailButton.textContent = 'Enviar';
                        emailButton.disabled = false;
                    }
                }, 1000);
            };
        }

        async function gerarFinalIdempotente() {
            try {
                if (info) info.textContent = 'Gerando seu documento...';

                if (orderId) {
                    for (var i = 0; i < 5; i++) {
                        try {
                            var rs = await fetch('/.netlify/functions/generate-doc', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ payload: { order_id: orderId }, preview: false })
                            });

                            if (rs.ok) {
                                var js = await rs.json();
                                if (js && js.output) {
                                    var fullTextS = renderDocText(js.output, null);
                                    docBox.textContent = fullTextS;
                                    docBox.style.display = 'block';
                                    actions.style.display = 'flex';
                                    if (info) info.textContent = '';
                                    attachActions(fullTextS, null);
                                    return;
                                }
                            }
                        } catch (e) { }
                        await new Promise(function (r) { setTimeout(r, 1500); });
                    }
                }

                var payloadStr = localStorage.getItem('pendingPayload');
                if (!payloadStr) {
                    if (info) info.textContent = 'Pagamento confirmado. Ainda estamos preparando seu documento. Aguarde alguns instantes e não feche esta página.';
                    for (var j = 0; j < 5; j++) {
                        try {
                            var rs2 = await fetch('/.netlify/functions/generate-doc', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ payload: { order_id: orderId }, preview: false })
                            });

                            if (rs2.ok) {
                                var js2 = await rs.json();
                                if (js2 && js2.output) {
                                    var fullTextS2 = renderDocText(js2.output, null);
                                    docBox.textContent = fullTextS2;
                                    docBox.style.display = 'block';
                                    actions.style.display = 'flex';
                                    if (info) info.textContent = '';
                                    attachActions(fullTextS2, null);
                                    return;
                                }
                            }
                        } catch (e) { }
                        await new Promise(function (r) { setTimeout(r, 1500); });
                    }
                    if (retry) retry.style.display = 'flex';
                    return;
                }

                var payload = JSON.parse(payloadStr);
                payload.order_id = orderId || null;

                var r = await fetch('/.netlify/functions/generate-doc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payload: payload, preview: false })
                });
                var data = await r.json();
                var out = data.output || data;

                var fullText = renderDocText(out, payload);
                docBox.textContent = fullText;
                docBox.style.display = 'block';
                actions.style.display = 'flex';
                if (info) info.textContent = '';
                attachActions(fullText, payload);

            } catch (e) {
                if (info) info.textContent = 'Falha ao preparar o documento. Tente novamente em instantes.';
                if (retry) retry.style.display = 'flex';
            }
        }
        async function sendConversionEC() { var ec = await buildECData(); gtag('event', 'conversion', { send_to: SEND_TO_CONVERSAO, value: 9.9, currency: 'BRL', transaction_id: orderId, user_data: ec }); } async function flow() { if (s === 'failure') { info.textContent = 'Pagamento não concluído. Você pode voltar ao documento ou tentar pagar novamente.'; retry.style.display = 'flex'; return; } info.textContent = 'Confirmando pagamento (pode levar alguns segundos com Pix)...'; if (!orderId) { info.textContent = 'Não conseguimos identificar o pedido. Clique em Voltar.'; retry.style.display = 'flex'; return; } var start = Date.now(); while (Date.now() - start < 60000) { var st = await getOrderStatus().catch(function () { return null; }); if (st && st.status === 'paid') { if (onceConv(orderId)) { await sendConversionEC(); } info.textContent = 'Pagamento confirmado. Gerando seu documento...'; await gerarFinalIdempotente(); return; } await new Promise(function (r) { setTimeout(r, 2000); }); } info.textContent = 'Ainda não conseguimos confirmar. Se você já pagou, aguarde alguns instantes; ou tente pagar novamente.'; retry.style.display = 'flex'; } flow();
    </script>

    <!-- Script de upsell inteligente baseado no slug -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            try {
                var s = (window.slug || '').toLowerCase();
                var cards = document.querySelectorAll('#extra-docs a[data-doc]');
                if (!cards.length) return;

                function hide(docType) {
                    cards.forEach(function (c) {
                        if (c.getAttribute('data-doc') === docType) {
                            c.style.display = 'none';
                        }
                    });
                }

                function prioritize(order) {
                    var container = document.querySelector('#extra-docs > div');
                    if (!container) return;
                    order.forEach(function (docType) {
                        cards.forEach(function (c) {
                            if (c.getAttribute('data-doc') === docType) {
                                container.prepend(c);
                            }
                        });
                    });
                }

                if (s.indexOf('viagem') > -1) {
                    // Comprou AUTORIZAÇÃO DE VIAGEM
                    hide('viagem');
                    prioritize(['reembolso', 'bagagem', 'multa']);
                } else if (s.indexOf('reembolso') > -1) {
                    // Comprou REEMBOLSO DE PASSAGEM
                    hide('reembolso');
                    prioritize(['bagagem', 'viagem', 'multa']);
                } else if (s.indexOf('bagagem') > -1) {
                    // Comprou BAGAGEM
                    hide('bagagem');
                    prioritize(['reembolso', 'viagem', 'multa']);
                } else if (s.indexOf('multa') > -1) {
                    // Comprou RECURSO DE MULTA
                    hide('multa');
                    prioritize(['reembolso', 'bagagem', 'viagem']);
                } else {
                    // Outros tipos (academias, serviços etc.)
                    prioritize(['reembolso', 'multa', 'bagagem', 'viagem']);
                }
            } catch (e) {
                console.error('Upsell error', e);
            }
        });
    </script>
</body>

</html>
