<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="/theme.js"></script>
    <script src="/utm.js"></script>
    <link rel="stylesheet" href="/style.css" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-1021062139"></script>
    <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'AW-1021062139', { 'allow_enhanced_conversions': true }); </script>
    <script
        type="text/javascript"> (function (c, l, a, r, i, t, y) { c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) }; t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i; y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y); })(window, document, "clarity", "script", "u4x90t35gk"); clarity("set", "maskText", true); </script>
    <title>Documento pronto</title>
</head>

<body>
    <div class="container">
        <div class="card">
            <h1>Seu documento</h1>
            <p id="info" class="small"></p>
            <div id="retry" style="display:none; margin:10px 0; gap:8px; flex-wrap:wrap"> <button class="btn"
                    id="btnBack">Voltar ao formulário</button> <button class="btn btn-outline" id="btnPay">Pagar
                    agora</button> </div>
            <div id="doc" class="preview" style="display:none" data-clarity-mask="true"></div>
            <div id="actions" style="display:none; gap:8px; margin-top:12px; flex-wrap:wrap"> <button class="btn"
                    id="btnCopiar">Copiar</button> <button class="btn btn-outline" id="btnDoc">Baixar .DOC</button>
                <button class="btn btn-outline" id="btnPdf">Baixar .PDF</button> <button class="btn btn-outline"
                    id="btnZap">Enviar no WhatsApp</button> <a class="btn btn-outline" id="btnSuporte" target="_blank"
                    rel="noopener">Falar no WhatsApp</a>
            </div>
            <p class="small" style="margin-top:8px">Dica: envie por e-mail para a empresa e leve impresso se necessário.
            </p>
            <div class="small" style="margin-top:16px;opacity:.9">Este site não presta aconselhamento jurídico. Leia os
                <a href="/termos.html" style="text-decoration:underline">Termos de Uso</a>.
            </div>
        </div>
    </div>
    <script src="/recovery.js"></script>
    <script> var SEND_TO_CONVERSAO = 'AW-1021062139/eWBbCPil_7kbEPvX8OYD'; function qs(n) { var u = new URL(location.href); return u.searchParams.get(n); } var orderId = qs('o'); var slug = qs('slug'); var s = qs('s'); var info = document.getElementById('info'); var retry = document.getElementById('retry'); var btnBack = document.getElementById('btnBack'); var btnPay = document.getElementById('btnPay'); var docBox = document.getElementById('doc'); var actions = document.getElementById('actions'); var btnCopiar = document.getElementById('btnCopiar'); var btnDoc = document.getElementById('btnDoc'); var btnPdf = document.getElementById('btnPdf'); var btnZap = document.getElementById('btnZap'); var btnSuporte = document.getElementById('btnSuporte'); function getOrderStatus() { return fetch('/.netlify/functions/order-status?o=' + encodeURIComponent(orderId)).then(function (r) { return r.ok ? r.json() : null; }); } btnBack.onclick = function () { if (slug && slug.indexOf('autorizacao-viagem') > -1) location.href = '/viagem.html'; else if (slug && slug.indexOf('carta-bagagem') > -1) location.href = '/bagagem.html'; else location.href = '/'; }; btnPay.onclick = async function () { var payloadStr = localStorage.getItem('pendingPayload'); if (!payloadStr) { btnBack.onclick(); return; } try { var p = JSON.parse(payloadStr); var r = await fetch('/.netlify/functions/mp-checkout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ slug: p.slug || slug || 'documento', price: 6.9, utm: p.utm || {} }) }); var data = await r.json(); if (r.ok && data.init_point) location.href = data.init_point; } catch (e) { } }; function renderDocText(out) { var partes = []; if (out.saudacao) partes.push(out.saudacao); var body = out.corpo_paragrafos || []; for (var i = 0; i < body.length; i++)partes.push(body[i]); if (out.fechamento) partes.push(out.fechamento); return partes.join('\n\n'); } function htmlBodyFromText(t) { return t.split('\n\n').map(function (p) { return '<p>' + p.replace(/\n/g, '<br/>') + '</p>'; }).join(''); } function onceConv(id) { try { var k = 'c:' + id; if (localStorage.getItem(k)) return false; localStorage.setItem(k, '1'); return true; } catch (e) { return true; } } function normalizeEmail(v) { if (!v) return ''; return String(v).trim().toLowerCase(); } function normalizePhone(v) { if (!v) return ''; var d = String(v).replace(/\D/g, ''); if (d.indexOf('55') !== 0) d = '55' + d; return d; } async function sha256Hex(s) { if (!s) return ''; var enc = new TextEncoder().encode(s); var buf = await crypto.subtle.digest('SHA-256', enc); var a = Array.from(new Uint8Array(buf)); return a.map(function (b) { return b.toString(16).padStart(2, '0'); }).join(''); } async function buildECData() { try { var p = JSON.parse(localStorage.getItem('pendingPayload') || '{}'); var em = normalizeEmail(p.email); var ph = normalizePhone(p.telefone); var ec = {}; if (em) ec.email = await sha256Hex(em); if (ph) ec.phone_number = await sha256Hex(ph); ec.address = { country: 'BR' }; return ec; } catch (e) { return { address: { country: 'BR' } }; } }
        function attachActions(fullText, payload) {
            var bodyHtml = htmlBodyFromText(fullText);
            btnCopiar.onclick = async function () { try { await navigator.clipboard.writeText(fullText); btnCopiar.textContent = 'Copiado!'; setTimeout(function () { btnCopiar.textContent = 'Copiar'; }, 1200); } catch (e) { } };
            btnDoc.onclick = function () { LMRecovery.doc(bodyHtml, 'documento'); };
            btnPdf.onclick = function () { LMRecovery.pdf(bodyHtml, 'documento'); };
            btnZap.onclick = function () { var url = 'https://api.whatsapp.com/send?text=' + encodeURIComponent(fullText); window.open(url, '_blank'); };
            btnSuporte.href = 'https://wa.me/5547991323024?text=' + encodeURIComponent('Oi! Preciso de ajuda. Pedido: ' + (orderId || '') + ' | Tipo: ' + (payload && payload.tipo || slug || ''));
            LMRecovery.saveGeneratedDoc({ html: bodyHtml, payload: payload || null, meta: { type: (payload && payload.tipo) || slug || '', orderId: orderId || '', filename: 'documento' } });
            localStorage.removeItem('pendingPayload');
        }

        async function gerarFinalIdempotente() {
            try {
                // Mostra status de trabalho
                if (info) info.textContent = 'Gerando seu documento...';

                // 1) Server-first: tenta pegar pelo order_id (até 5 tentativas) – funciona quando o webhook já gerou
                if (orderId) {
                    for (var i = 0; i < 5; i++) {
                        try {
                            var rs = await fetch('/.netlify/functions/generate-doc', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ payload: { order_id: orderId }, preview: false })
                            });
                            var js = await rs.json();
                            if (rs.ok && js && js.output) {
                                var fullTextS = renderDocText(js.output, null);
                                docBox.textContent = fullTextS;
                                docBox.style.display = 'block';
                                actions.style.display = 'flex';
                                if (info) info.textContent = '';
                                attachActions(fullTextS, null);
                                return;
                            }
                        } catch (e) { /* tenta de novo */ }
                        await new Promise(function (r) { setTimeout(r, 1500); });
                    }
                }

                // 2) Fallback local: se ainda não encontrou no servidor, usa o payload salvo no navegador e gera
                var payloadStr = localStorage.getItem('pendingPayload');
                if (!payloadStr) {
                    if (info) info.textContent = 'Pagamento confirmado. Ainda estamos preparando seu documento. Aguarde alguns instantes e não feche esta página.';
                    // dá mais algumas tentativas de servidor, caso o webhook esteja chegando com atraso
                    for (var j = 0; j < 5; j++) {
                        try {
                            var rs2 = await fetch('/.netlify/functions/generate-doc', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ payload: { order_id: orderId }, preview: false })
                            });
                            var js2 = await rs2.json();
                            if (rs2.ok && js2 && js2.output) {
                                var fullTextS2 = renderDocText(js2.output, null);
                                docBox.textContent = fullTextS2;
                                docBox.style.display = 'block';
                                actions.style.display = 'flex';
                                if (info) info.textContent = '';
                                attachActions(fullTextS2, null);
                                return;
                            }
                        } catch (e) { }
                        await new Promise(function (r) { setTimeout(r, 1500); });
                    }
                    // Não achou mesmo
                    if (retry) retry.style.display = 'flex';
                    return;
                }

                // 3) Gera com o payload local (e grava/vincula ao order_id)
                var payload = JSON.parse(payloadStr);
                payload.order_id = orderId || null;

                var r = await fetch('/.netlify/functions/generate-doc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payload: payload, preview: false })
                });
                var data = await r.json();
                var out = data.output || data;

                var fullText = renderDocText(out, payload);
                docBox.textContent = fullText;
                docBox.style.display = 'block';
                actions.style.display = 'flex';
                if (info) info.textContent = '';
                attachActions(fullText, payload);

            } catch (e) {
                if (info) info.textContent = 'Falha ao preparar o documento. Tente novamente em instantes.';
                if (retry) retry.style.display = 'flex';
            }
        }
        async function sendConversionEC() { var ec = await buildECData(); gtag('event', 'conversion', { send_to: SEND_TO_CONVERSAO, value: 6.9, currency: 'BRL', transaction_id: orderId, user_data: ec }); } async function flow() { if (s === 'failure') { info.textContent = 'Pagamento não concluído. Você pode voltar ao documento ou tentar pagar novamente.'; retry.style.display = 'flex'; return; } info.textContent = 'Confirmando pagamento (pode levar alguns segundos com Pix)...'; if (!orderId) { info.textContent = 'Não conseguimos identificar o pedido. Clique em Voltar.'; retry.style.display = 'flex'; return; } var start = Date.now(); while (Date.now() - start < 60000) { var st = await getOrderStatus().catch(function () { return null; }); if (st && st.status === 'paid') { if (onceConv(orderId)) { await sendConversionEC(); } info.textContent = 'Pagamento confirmado. Gerando seu documento...'; await gerarFinalIdempotente(); return; } await new Promise(function (r) { setTimeout(r, 2000); }); } info.textContent = 'Ainda não conseguimos confirmar. Se você já pagou, aguarde alguns instantes; ou tente pagar novamente.'; retry.style.display = 'flex'; } flow(); </script>
</body>

</html>