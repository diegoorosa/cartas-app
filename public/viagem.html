<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <title>Autoriza√ß√£o de Viagem para Menor</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="/theme.js"></script>
    <link rel="stylesheet" href="/style.css" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-1021062139"></script>
    <script src="/gtag.js"></script>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="/" class="logo">CartasApp</a>
                <div class="nav-actions">
                    <button class="btn-theme" onclick="toggleTheme()" aria-label="Alternar tema">
                        üåô
                    </button>
                    <a href="https://wa.me/5547991323024" class="btn btn-secondary btn-sm" target="_blank">
                        WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero" style="padding: 60px 0 40px;">
        <div class="container">
            <div class="hero-content">
                <div class="hero-badge">
                    ‚úàÔ∏è Autoriza√ß√£o de Viagem
                </div>
                <h1 style="font-size: 48px;">Autoriza√ß√£o de Viagem para Menor</h1>
                <p class="hero-subtitle">
                    Preencha os dados e gere a autoriza√ß√£o em minutos. Documento em .DOC pronto para imprimir e assinar.
                </p>
            </div>
        </div>
    </section>

    <!-- Form Section -->
    <section class="section" style="padding-top: 0;">
        <div class="container">
            <div style="max-width: 800px; margin: 0 auto;">
                <div class="card">
                    <div
                        style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 32px;">
                        <p class="small" style="margin: 0; color: var(--text-secondary);">
                            <strong>Documentos necess√°rios:</strong> Nacional: certid√£o de nascimento (original/c√≥pia)
                            ou RG do menor. Internacional: passaporte do menor (RG pode ser aceito no Mercosul, mas
                            recomenda-se passaporte). CPF n√£o substitui documento de identidade.
                        </p>
                    </div>

                    <div id="formArea">
                        <h2 class="section-title" style="font-size: 24px; margin-bottom: 24px;">Dados do menor</h2>

                        <label class="label">Nome completo do menor</label>
                        <input class="input" id="menor_nome" placeholder="Ex.: Ana Souza" />

                        <label class="label">Data de nascimento</label>
                        <input class="input" id="menor_nascimento" placeholder="DD/MM/AAAA" inputmode="numeric"
                            maxlength="10" />
                        <div id="err_menor_nascimento" class="small" style="display:none;color:#fca5a5;margin-top:4px;">
                            Data de nascimento inv√°lida.</div>

                        <label class="label">Documento do menor (certid√£o/RG/passaporte)</label>
                        <input class="input" id="menor_doc" placeholder="Ex.: Certid√£o ‚Äî Livro X, Folha Y" />

                        <h2 class="section-title" style="font-size: 24px; margin: 32px 0 24px;">Viagem</h2>

                        <label class="label">Tipo</label>
                        <select class="input" id="viagem_tipo">
                            <option value="nacional">Nacional</option>
                            <option value="internacional">Internacional</option>
                        </select>

                        <label class="label">Destino</label>
                        <input class="input" id="destino" placeholder="Ex.: Curitiba/PR ou Lisboa/Portugal" />

                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px;">
                            <div>
                                <label class="label">Data de ida</label>
                                <input class="input" id="data_ida" placeholder="DD/MM/AAAA" inputmode="numeric"
                                    maxlength="10" />
                                <div id="err_data_ida" class="small" style="display:none;color:#fca5a5;margin-top:4px;">
                                    Data de ida inv√°lida.</div>
                            </div>
                            <div>
                                <label class="label">Data de volta</label>
                                <input class="input" id="data_volta" placeholder="DD/MM/AAAA" inputmode="numeric"
                                    maxlength="10" />
                                <div id="err_data_volta" class="small"
                                    style="display:none;color:#fca5a5;margin-top:4px;">Data de volta inv√°lida ou
                                    anterior √† ida.</div>
                            </div>
                        </div>

                        <h2 class="section-title" style="font-size: 24px; margin: 32px 0 24px;">Acompanhante</h2>

                        <label class="label">Acompanhado por</label>
                        <select class="input" id="acompanhado_por">
                            <option value="nenhum">Sem acompanhante</option>
                            <option value="resp1">Respons√°vel 1</option>
                            <option value="resp2">Respons√°vel 2</option>
                            <option value="terceiro">Parente/Terceiro</option>
                        </select>

                        <div id="terceiroBox" style="display:none;margin-top:20px;">
                            <label class="label">Nome do acompanhante</label>
                            <input class="input" id="acomp_nome" placeholder="Ex.: Tia Carla" />

                            <label class="label">Documento do acompanhante</label>
                            <input class="input" id="acomp_doc" placeholder="Ex.: RG 99.888.777-6" />

                            <label class="label">Parentesco</label>
                            <input class="input" id="acomp_parentesco" placeholder="Ex.: Tia / Av√≥ / Madrinha" />
                        </div>

                        <h2 class="section-title" style="font-size: 24px; margin: 32px 0 24px;">Respons√°vel(veis) que
                            autorizam</h2>

                        <label class="label">Respons√°vel 1 ‚Äî Nome completo</label>
                        <input class="input" id="resp1_nome" placeholder="Ex.: Maria Souza" />

                        <label class="label">Respons√°vel 1 ‚Äî CPF</label>
                        <input class="input" id="resp1_cpf" placeholder="000.000.000-00" inputmode="numeric"
                            maxlength="14" />
                        <div id="err_resp1_cpf" class="small" style="display:none;color:#fca5a5;margin-top:4px;">CPF do
                            Respons√°vel 1 inv√°lido.</div>

                        <label class="label">Respons√°vel 1 ‚Äî Documento (RG/Passaporte) [opcional]</label>
                        <input class="input" id="resp1_doc" placeholder="Ex.: RG 11.222.333-4" />

                        <label class="label">Parentesco</label>
                        <select class="input" id="resp1_parentesco">
                            <option>M√£e</option>
                            <option>Pai</option>
                            <option>Respons√°vel legal</option>
                            <option>Tutor(a)</option>
                        </select>

                        <div style="margin-top:20px;padding:16px;background:var(--card-hover);border-radius:12px;">
                            <label class="small" style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                <input type="checkbox" id="dois_resps" style="width:18px;height:18px;cursor:pointer;" />
                                <span>Dois respons√°veis assinam</span>
                            </label>
                        </div>

                        <div id="resp2Box" style="display:none;margin-top:24px;">
                            <h3 style="font-size: 20px; margin-bottom: 20px; color: var(--text-primary);">Respons√°vel 2
                            </h3>

                            <label class="label">Nome completo</label>
                            <input class="input" id="resp2_nome" placeholder="Ex.: Jo√£o Souza" />

                            <label class="label">CPF</label>
                            <input class="input" id="resp2_cpf" placeholder="000.000.000-00" inputmode="numeric"
                                maxlength="14" />
                            <div id="err_resp2_cpf" class="small" style="display:none;color:#fca5a5;margin-top:4px;">CPF
                                do Respons√°vel 2 inv√°lido.</div>

                            <label class="label">Documento (RG/Passaporte) [opcional]</label>
                            <input class="input" id="resp2_doc" placeholder="Ex.: RG 55.666.777-8" />

                            <label class="label">Parentesco</label>
                            <select class="input" id="resp2_parentesco">
                                <option>Pai</option>
                                <option>M√£e</option>
                                <option>Respons√°vel legal</option>
                                <option>Tutor(a)</option>
                            </select>
                        </div>

                        <h2 class="section-title" style="font-size: 24px; margin: 32px 0 24px;">Local e contatos</h2>

                        <label class="label">Cidade/UF de emiss√£o</label>
                        <input class="input" id="cidade_uf_emissao" placeholder="Ex.: Blumenau/SC" />

                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px;">
                            <div>
                                <label class="label">E-mail (opcional)</label>
                                <input class="input" id="email" placeholder="Ex.: seu@email.com" />
                            </div>
                            <div>
                                <label class="label">Telefone (opcional)</label>
                                <input class="input" id="telefone" placeholder="Ex.: (47) 99999-9999" />
                            </div>
                        </div>

                        <label class="label">Observa√ß√µes (opcional)</label>
                        <textarea class="input" id="observacoes" rows="3"
                            placeholder="Ex.: Autoriza√ß√£o v√°lida apenas para o per√≠odo informado."></textarea>

                        <div style="margin-top:32px; display:flex; gap:12px; flex-wrap:wrap">
                            <button class="btn btn-secondary" id="btnPreview">Gerar pr√©via</button>
                            <button class="btn btn-primary" id="btnPagar" disabled>Gerar documento completo (R$
                                9,90)</button>
                        </div>
                    </div>

                    <div id="previewWrap"
                        style="display:none; margin-top:32px; padding-top:32px; border-top:1px solid var(--border);">
                        <h2 class="section-title" style="font-size: 24px; margin-bottom: 20px;">Pr√©via do documento</h2>
                        <div
                            style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:24px;">
                            <div id="previewBox"
                                style="white-space:pre-wrap;font-family:monospace;font-size:14px;line-height:1.8;color:var(--text-secondary);">
                            </div>
                        </div>
                        <p class="small" style="margin-top:12px;color:var(--text-muted);">
                            Pr√©via parcial. Na vers√£o completa voc√™ poder√° copiar, baixar .DOC e enviar no WhatsApp.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <p>Este site n√£o presta aconselhamento jur√≠dico. Leia os <a href="/termos.html"
                        class="footer-link">Termos de Uso</a>.</p>
            </div>
        </div>
    </footer>

    <script>
        function maskCPF(v) { v = (v || '').replace(/\D/g, '').slice(0, 11); v = v.replace(/(\d{3})(\d)/, '$1.$2'); v = v.replace(/(\d{3})(\d)/, '$1.$2'); v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2'); return v; }
        function isValidCPF(cpf) { var s = (cpf || '').replace(/\D/g, ''); if (s.length !== 11) return false; if (/^(\d)\1{10}$/.test(s)) return false; var i, sum = 0, rest; for (i = 1; i <= 9; i++) sum += parseInt(s.substring(i - 1, i)) * (11 - i); rest = (sum * 10) % 11; if (rest === 10 || rest === 11) rest = 0; if (rest !== parseInt(s.substring(9, 10))) return false; sum = 0; for (i = 1; i <= 10; i++) sum += parseInt(s.substring(i - 1, i)) * (12 - i); rest = (sum * 10) % 11; if (rest === 10 || rest === 11) rest = 0; if (rest !== parseInt(s.substring(10, 11))) return false; return true; }
        function maskDate(v) { v = (v || '').replace(/\D/g, '').slice(0, 8); if (v.length >= 5) v = v.replace(/(\d{2})(\d{2})(\d{1,4})/, '$1/$2/$3'); else if (v.length >= 3) v = v.replace(/(\d{2})(\d{1,2})/, '$1/$2'); return v; }
        function isValidDateBR(s) { if (!/^\d{2}\/\d{2}\/\d{4}$/.test(s || '')) return false; var d = parseInt(s.substr(0, 2), 10), m = parseInt(s.substr(3, 2), 10), y = parseInt(s.substr(6, 4), 10); if (y < 1900 || y > 2100 || m < 1 || m > 12 || d < 1 || d > 31) return false; var md = [31, (y % 4 === 0 && y % 100 !== 0) || y % 400 === 0 ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]; if (d > md[m - 1]) return false; return true; }
        function dateToISO(s) { var d = s.substr(0, 2), m = s.substr(3, 2), y = s.substr(6, 4); return y + '-' + m + '-' + d; }

        var ids = ['menor_nome', 'menor_nascimento', 'menor_doc', 'viagem_tipo', 'destino', 'data_ida', 'data_volta', 'acompanhado_por', 'acomp_nome', 'acomp_doc', 'acomp_parentesco', 'resp1_nome', 'resp1_cpf', 'resp1_doc', 'resp1_parentesco', 'dois_resps', 'resp2_nome', 'resp2_cpf', 'resp2_doc', 'resp2_parentesco', 'cidade_uf_emissao', 'email', 'telefone', 'observacoes'];
        var SAVE_KEY = 'viagem_form_v2';

        function saveForm() { var o = {}; for (var i = 0; i < ids.length; i++) { var el = document.getElementById(ids[i]); if (!el) continue; if (el.type === 'checkbox') o[ids[i]] = el.checked; else o[ids[i]] = el.value; } localStorage.setItem(SAVE_KEY, JSON.stringify(o)); }
        function loadForm() { try { var o = JSON.parse(localStorage.getItem(SAVE_KEY) || '{}'); for (var k in o) { var el = document.getElementById(k); if (!el) continue; if (el.type === 'checkbox') { el.checked = !!o[k]; el.dispatchEvent(new Event('change')); } else { el.value = o[k]; } } } catch (e) { } }
        function attachAutosave() { for (var i = 0; i < ids.length; i++) { var el = document.getElementById(ids[i]); if (!el) continue; el.addEventListener('input', saveForm); el.addEventListener('change', saveForm); } }

        var resp1_cpf = document.getElementById('resp1_cpf');
        var resp2_cpf = document.getElementById('resp2_cpf');
        if (resp1_cpf) { resp1_cpf.addEventListener('input', function () { this.value = maskCPF(this.value); }); }
        if (resp2_cpf) { resp2_cpf.addEventListener('input', function () { this.value = maskCPF(this.value); }); }

        var dIds = ['menor_nascimento', 'data_ida', 'data_volta'];
        for (var i = 0; i < dIds.length; i++) { var e = document.getElementById(dIds[i]); if (e) { e.addEventListener('input', function (ev) { ev.target.value = maskDate(ev.target.value); }); } }

        var acompSel = document.getElementById('acompanhado_por');
        var terceiroBox = document.getElementById('terceiroBox');
        acompSel.addEventListener('change', function () { terceiroBox.style.display = (this.value === 'terceiro') ? 'block' : 'none'; });

        var dois = document.getElementById('dois_resps');
        var resp2Box = document.getElementById('resp2Box');
        dois.addEventListener('change', function () { resp2Box.style.display = this.checked ? 'block' : 'none'; });

        function getPayload() {
            if (resp1_cpf) resp1_cpf.value = maskCPF(resp1_cpf.value);
            if (resp2_cpf) resp2_cpf.value = maskCPF(resp2_cpf.value);
            return {
                slug: 'autorizacao-viagem-menor',
                tipo: 'autorizacao_viagem',
                entidade: 'Viagem',
                menor_nome: document.getElementById('menor_nome').value.trim(),
                menor_nascimento: document.getElementById('menor_nascimento').value.trim(),
                menor_doc: document.getElementById('menor_doc').value.trim(),
                viagem_tipo: document.getElementById('viagem_tipo').value,
                destino: document.getElementById('destino').value.trim(),
                data_ida: document.getElementById('data_ida').value.trim(),
                data_volta: document.getElementById('data_volta').value.trim(),
                acompanhado_por: document.getElementById('acompanhado_por').value,
                acomp_nome: document.getElementById('acomp_nome').value.trim(),
                acomp_doc: document.getElementById('acomp_doc').value.trim(),
                acomp_parentesco: document.getElementById('acomp_parentesco').value.trim(),
                resp1_nome: document.getElementById('resp1_nome').value.trim(),
                resp1_cpf: document.getElementById('resp1_cpf').value.trim(),
                resp1_doc: document.getElementById('resp1_doc').value.trim(),
                resp1_parentesco: document.getElementById('resp1_parentesco').value,
                dois_resps: document.getElementById('dois_resps').checked,
                resp2_nome: document.getElementById('resp2_nome').value.trim(),
                resp2_cpf: document.getElementById('resp2_cpf').value.trim(),
                resp2_doc: document.getElementById('resp2_doc').value.trim(),
                resp2_parentesco: document.getElementById('resp2_parentesco').value,
                cidade_uf_emissao: document.getElementById('cidade_uf_emissao').value.trim(),
                email: document.getElementById('email').value.trim(),
                telefone: document.getElementById('telefone').value.trim(),
                observacoes: document.getElementById('observacoes').value.trim()
            };
        }

        function validateAll(p) {
            var ok = true;
            function show(id, show) { var el = document.getElementById(id); if (el) el.style.display = show ? 'block' : 'none'; }
            if (!/^\d{2}\/\d{2}\/\d{4}$/.test(p.menor_nascimento) || !isValidDateBR(p.menor_nascimento)) { show('err_menor_nascimento', true); ok = false; } else show('err_menor_nascimento', false);
            if (!isValidDateBR(p.data_ida)) { show('err_data_ida', true); ok = false; } else show('err_data_ida', false);
            if (!isValidDateBR(p.data_volta)) { show('err_data_volta', true); ok = false; } else {
                var di = new Date(dateToISO(p.data_ida)); var dv = new Date(dateToISO(p.data_volta));
                if (isNaN(di.getTime()) || isNaN(dv.getTime()) || dv.getTime() < di.getTime()) { show('err_data_volta', true); ok = false; } else show('err_data_volta', false);
            }
            if (!isValidCPF(p.resp1_cpf)) { show('err_resp1_cpf', true); ok = false; } else show('err_resp1_cpf', false);
            if (p.dois_resps && p.resp2_cpf && !isValidCPF(p.resp2_cpf)) { show('err_resp2_cpf', true); ok = false; } else show('err_resp2_cpf', false);
            if (!p.menor_nome || !p.resp1_nome || !p.destino || !p.cidade_uf_emissao) ok = false;
            return ok;
        }

        var btnPreview = document.getElementById('btnPreview');
        var btnPagar = document.getElementById('btnPagar');
        var previewWrap = document.getElementById('previewWrap');
        var previewBox = document.getElementById('previewBox');

        loadForm();
        attachAutosave();

        (function () {
            var p = new URL(location.href).searchParams.get('pref');
            if (!p) return;
            var tipo = document.getElementById('viagem_tipo');
            if (p === 'nat1' || p === 'nat2' || p === 'terc_nac') tipo.value = 'nacional';
            if (p === 'int1' || p === 'int2' || p === 'terc_int') tipo.value = 'internacional';
            if (p === 'int2' || p === 'nat2') { var chk = document.getElementById('dois_resps'); chk.checked = true; chk.dispatchEvent(new Event('change')); }
            if (p === 'terc_nac' || p === 'terc_int') { document.getElementById('acompanhado_por').value = 'terceiro'; terceiroBox.style.display = 'block'; }
        })();

        btnPreview.addEventListener('click', function () {
            (async function () {
                btnPreview.disabled = true; btnPreview.textContent = 'Gerando...';
                try {
                    var payload = getPayload();
                    if (!validateAll(payload)) { alert('Verifique os campos destacados.'); btnPreview.disabled = false; btnPreview.textContent = 'Gerar pr√©via'; return; }
                    saveForm();

                    var r = await fetch('/.netlify/functions/generate-doc', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ payload: payload, preview: true })
                    });
                    if (!r.ok) throw new Error('Falha ao gerar');
                    var data = await r.json();
                    var out = data.output || data;

                    var pars = out.corpo_paragrafos || [];
                    var keep = Math.max(1, Math.min(2, pars.length));
                    var parcialText = pars.slice(0, keep).join('\n\n') + '\n\n[...]';
                    var saud = out.saudacao || '';
                    var checklist = out.check_list_anexos || [];
                    var chkShow = checklist.slice(0, 2); if (checklist.length > 2) chkShow.push('...');

                    var finalPreview = (saud ? saud + '\n\n' : '') + parcialText + '\n\nChecklist de anexos (parcial): ' + chkShow.join('; ');
                    previewBox.textContent = finalPreview;
                    previewWrap.style.display = 'block';

                    localStorage.setItem('pendingPayload', JSON.stringify(payload));
                    btnPagar.disabled = false;
                } catch (e) { alert('Erro ao gerar pr√©via.'); }
                finally { btnPreview.disabled = false; btnPreview.textContent = 'Gerar pr√©via'; }
            })();
        });

        btnPagar.addEventListener('click', async function () {
            try {
                var payload = getPayload();
                var ok = true;
                if (typeof validateAll === 'function') {
                    ok = validateAll(payload);
                } else {
                    ok =
                        payload &&
                        payload.menor_nome &&
                        payload.menor_nascimento &&
                        payload.resp1_nome &&
                        payload.resp1_cpf &&
                        payload.destino &&
                        payload.data_ida &&
                        payload.data_volta &&
                        payload.cidade_uf_emissao;
                }
                if (!ok) { alert('Verifique os campos obrigat√≥rios.'); return; }

                if (typeof saveForm === 'function') { saveForm(); }
                localStorage.setItem('pendingPayload', JSON.stringify(payload));
                btnPagar.disabled = true; btnPagar.textContent = 'Preparando...';

                var slugStr = (typeof slug !== 'undefined' && slug) ? slug : 'autorizacao-viagem-menor';
                var r = await fetch('/.netlify/functions/mp-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        slug: slugStr,
                        payload: payload,
                        utm: (window.LMUTM ? LMUTM.get() : {})
                    })
                });
                var data = await r.json();
                if (!r.ok || !data.init_point) throw 0;

                localStorage.setItem('lastOrderId', data.order_id || '');
                if (typeof gtag === 'function') { gtag('event', 'begin_checkout', { value: 9.9, currency: 'BRL', items: [{ item_id: slugStr }] }); }
                showPaymentModal(data.init_point, data.order_id, slugStr);
            } catch (e) {
                alert('N√£o foi poss√≠vel abrir o pagamento.');
                btnPagar.disabled = false; btnPagar.textContent = 'Gerar documento completo (R$ 9,90)';
            }
        });

        function showPaymentModal(initPoint, orderId, slug) {
            var isLight = (document.documentElement.getAttribute('data-theme') === 'light');
            var cardBG = isLight ? '#ffffff' : '#111827';
            var cardText = isLight ? '#0f172a' : '#e6eefb';

            var overlay = document.createElement('div');
            overlay.style = 'position:fixed;inset:0;background:rgba(2,6,23,.65);backdrop-filter:blur(6px) saturate(120%);-webkit-backdrop-filter:blur(6px) saturate(120%);z-index:9999;display:flex;align-items:center;justify-content:center';
            overlay.innerHTML = '<div style="background:' + cardBG + ';color:' + cardText + ';border:1px solid var(--border);border-radius:14px;max-width:560px;width:92%;padding:20px;box-shadow:0 18px 44px rgba(0,0,0,.28)">' +
                '<h3 style="margin:0 0 8px">Pagamento</h3>' +
                '<p style="margin:0 0 10px">Abriremos o Mercado Pago em uma nova aba. Ap√≥s pagar, se n√£o redirecionar, volte para esta aba. Assim que o pagamento for confirmado, vamos liberar seu documento automaticamente.</p>' +
                '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">' +
                '<button id="lm-goPay" class="btn">Ir para pagamento</button>' +
                '<button id="lm-copy" class="btn btn-outline">Copiar link de recupera√ß√£o</button>' +
                '<button id="lm-close" class="btn btn-outline">Fechar</button>' +
                '</div>' +
                '<p id="lm-statusPay" class="small" style="margin-top:10px"></p>' +
                '</div>';
            document.body.appendChild(overlay);

            document.getElementById('lm-close').onclick = function () { overlay.remove(); };
            document.getElementById('lm-copy').onclick = function () {
                var link = location.origin + '/recuperar.html?o=' + encodeURIComponent(orderId);
                navigator.clipboard.writeText(link);
                this.textContent = 'Link copiado';
                setTimeout(() => this.textContent = 'Copiar link de recupera√ß√£o', 1200);
            };

            async function docReady() {
                try {
                    var r = await fetch('/.netlify/functions/generate-doc', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ payload: { order_id: orderId }, preview: false })
                    });
                    if (!r.ok) return false;
                    var j = await r.json();
                    return !!(j && j.output);
                } catch (e) { return false; }
            }

            document.getElementById('lm-goPay').onclick = function () {
                var w = window.open(initPoint, '_blank', 'noopener');
                var st = document.getElementById('lm-statusPay');
                st.textContent = 'Aguardando confirma√ß√£o do pagamento...';
                var start = Date.now();
                var iv = setInterval(async function () {
                    try {
                        // 1) Se o documento j√° existe (webhook gerou), redireciona
                        if (await docReady()) {
                            clearInterval(iv);
                            location.href = '/success.html?o=' + encodeURIComponent(orderId) + '&slug=' + encodeURIComponent(slug || 'documento') + '&s=success';
                            return;
                        }
                        // 2) Order status tamb√©m (se dispon√≠vel)
                        var rr = await fetch('/.netlify/functions/order-status?o=' + encodeURIComponent(orderId));
                        var jj = rr.ok ? await rr.json() : null;
                        if (jj && jj.status === 'paid') {
                            clearInterval(iv);
                            location.href = '/success.html?o=' + encodeURIComponent(orderId) + '&slug=' + encodeURIComponent(slug || 'documento') + '&s=success';
                            return;
                        }
                        // 3) Timeout 10 min
                        if (Date.now() - start > 600000) {
                            clearInterval(iv);
                            st.textContent = 'Ainda n√£o confirmamos. Se voc√™ j√° pagou, use o link copiado para recuperar.';
                        }
                    } catch (e) { }
                }, 3000);
            };
        }

    </script>
</body>

</html>