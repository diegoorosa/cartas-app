<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <title>Autorização de Viagem para Menor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-1021062139"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'AW-1021062139');
  </script>
</head>

<body>
  <div class="container">
    <div class="header">
      <a href="/" class="small" style="text-decoration:none;color:#93c5fd">← Voltar</a>
      <span class="badge">Autorização</span>
    </div>

    <div class="card">
      <h1>Autorização de Viagem para Menor</h1>
      <p class="small">Preencha os dados e gere a autorização em minutos. Documento em .DOC pronto para imprimir e
        assinar.</p>

      <div id="formArea">
        <h2>Dados do menor</h2>
        <label class="label">Nome completo do menor</label>
        <input class="input" id="menor_nome" placeholder="Ex.: Ana Souza" />

        <label class="label">Data de nascimento</label>
        <input class="input" id="menor_nascimento" type="date" />

        <label class="label">Documento do menor (RG/Passaporte)</label>
        <input class="input" id="menor_doc" placeholder="Ex.: RG 12.345.678-9" />

        <h2>Responsável 1</h2>
        <label class="label">Nome completo</label>
        <input class="input" id="resp1_nome" placeholder="Ex.: Maria Souza" />
        <label class="label">CPF</label>
        <input class="input" id="resp1_cpf" placeholder="000.000.000-00" inputmode="numeric" maxlength="14" />
        <div id="cpf1Error" class="small" style="display:none;color:#fca5a5">CPF inválido do responsável 1.</div>
        <label class="label">Documento (RG/Passaporte)</label>
        <input class="input" id="resp1_doc" placeholder="Ex.: RG 11.222.333-4" />
        <label class="label">Parentesco</label>
        <select class="input" id="resp1_parentesco">
          <option>Mãe</option>
          <option>Pai</option>
          <option>Responsável legal</option>
          <option>Tutor(a)</option>
        </select>

        <div style="margin-top:12px">
          <label class="small"><input type="checkbox" id="dois_resps" /> Dois responsáveis assinam</label>
        </div>

        <div id="resp2Box" style="display:none">
          <h2>Responsável 2</h2>
          <label class="label">Nome completo</label>
          <input class="input" id="resp2_nome" placeholder="Ex.: João Souza" />
          <label class="label">CPF</label>
          <input class="input" id="resp2_cpf" placeholder="000.000.000-00" inputmode="numeric" maxlength="14" />
          <div id="cpf2Error" class="small" style="display:none;color:#fca5a5">CPF inválido do responsável 2.</div>
          <label class="label">Documento (RG/Passaporte)</label>
          <input class="input" id="resp2_doc" placeholder="Ex.: RG 55.666.777-8" />
          <label class="label">Parentesco</label>
          <select class="input" id="resp2_parentesco">
            <option>Pai</option>
            <option>Mãe</option>
            <option>Responsável legal</option>
            <option>Tutor(a)</option>
          </select>
        </div>

        <h2>Viagem</h2>
        <label class="label">Tipo de viagem</label>
        <select class="input" id="viagem_tipo">
          <option value="nacional">Nacional</option>
          <option value="internacional">Internacional</option>
        </select>

        <label class="label">Acompanhado por</label>
        <select class="input" id="acompanhado_por">
          <option value="nenhum">Sem acompanhante</option>
          <option value="resp1">Responsável 1</option>
          <option value="resp2">Responsável 2</option>
          <option value="terceiro">Parente/Terceiro</option>
        </select>

        <div id="terceiroBox" style="display:none">
          <label class="label">Nome do acompanhante</label>
          <input class="input" id="acomp_nome" placeholder="Ex.: Tia Carla" />
          <label class="label">Documento do acompanhante</label>
          <input class="input" id="acomp_doc" placeholder="Ex.: RG 99.888.777-6" />
          <label class="label">Parentesco</label>
          <input class="input" id="acomp_parentesco" placeholder="Ex.: Tia / Avó / Madrinha" />
        </div>

        <label class="label">Destino</label>
        <input class="input" id="destino" placeholder="Ex.: São Paulo/SP ou Lisboa/Portugal" />

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label class="label">Data de ida</label>
            <input class="input" id="data_ida" type="date" />
          </div>
          <div>
            <label class="label">Data de volta</label>
            <input class="input" id="data_volta" type="date" />
          </div>
        </div>

        <h2>Contatos e local de assinatura</h2>
        <label class="label">Cidade/UF de assinatura</label>
        <input class="input" id="cidade_uf_emissao" placeholder="Ex.: Blumenau/SC" />
        <label class="label">E-mail de contato</label>
        <input class="input" id="email" placeholder="Ex.: seuemail@exemplo.com" />
        <label class="label">Telefone</label>
        <input class="input" id="telefone" placeholder="Ex.: (47) 99999-9999" />

        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" id="btnPreview">Gerar prévia</button>
          <button class="btn btn-outline" id="btnPagar" disabled>Gerar documento completo (R$ 6,90)</button>
        </div>
      </div>

      <div id="previewWrap" style="display:none; margin-top:16px">
        <h2>Prévia do documento</h2>
        <div class="preview" id="previewBox"></div>
        <p class="small" style="margin-top:8px">Parte final ocultada. Na versão completa você poderá copiar, baixar .DOC
          e enviar no WhatsApp.</p>
      </div>
    </div>
  </div>

  <script>
    function maskCPF(v) { v = (v || '').replace(/\D/g, '').slice(0, 11); v = v.replace(/(\d{3})(\d)/, '$1.$2'); v = v.replace(/(\d{3})(\d)/, '$1.$2'); v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2'); return v; }
    function isValidCPF(cpf) { var s = (cpf || '').replace(/\D/g, ''); if (s.length !== 11) return false; if (/^(\d)\1{10}$/.test(s)) return false; var i, sum = 0, rest; for (i = 1; i <= 9; i++) sum += parseInt(s.substring(i - 1, i)) * (11 - i); rest = (sum * 10) % 11; if (rest === 10 || rest === 11) rest = 0; if (rest !== parseInt(s.substring(9, 10))) return false; sum = 0; for (i = 1; i <= 10; i++) sum += parseInt(s.substring(i - 1, i)) * (12 - i); rest = (sum * 10) % 11; if (rest === 10 || rest === 11) rest = 0; if (rest !== parseInt(s.substring(10, 11))) return false; return true; }
    var resp1_cpf = document.getElementById('resp1_cpf');
    var resp2_cpf = document.getElementById('resp2_cpf');
    if (resp1_cpf) { resp1_cpf.addEventListener('input', function () { this.value = maskCPF(this.value); }); }
    if (resp2_cpf) { resp2_cpf.addEventListener('input', function () { this.value = maskCPF(this.value); }); }

    var dois = document.getElementById('dois_resps');
    var resp2Box = document.getElementById('resp2Box');
    dois.addEventListener('change', function () { resp2Box.style.display = this.checked ? 'block' : 'none'; });

    var acompSel = document.getElementById('acompanhado_por');
    var terceiroBox = document.getElementById('terceiroBox');
    acompSel.addEventListener('change', function () { terceiroBox.style.display = (this.value === 'terceiro') ? 'block' : 'none'; });

    function getPayload() {
      if (resp1_cpf) resp1_cpf.value = maskCPF(resp1_cpf.value);
      if (resp2_cpf) resp2_cpf.value = maskCPF(resp2_cpf.value);
      return {
        tipo: 'autorizacao_viagem',
        slug: 'autorizacao-viagem-menor',
        menor_nome: document.getElementById('menor_nome').value.trim(),
        menor_nascimento: document.getElementById('menor_nascimento').value,
        menor_doc: document.getElementById('menor_doc').value.trim(),
        resp1_nome: document.getElementById('resp1_nome').value.trim(),
        resp1_cpf: document.getElementById('resp1_cpf').value.trim(),
        resp1_doc: document.getElementById('resp1_doc').value.trim(),
        resp1_parentesco: document.getElementById('resp1_parentesco').value,
        dois_resps: document.getElementById('dois_resps').checked,
        resp2_nome: document.getElementById('resp2_nome')?.value.trim() || '',
        resp2_cpf: document.getElementById('resp2_cpf')?.value.trim() || '',
        resp2_doc: document.getElementById('resp2_doc')?.value.trim() || '',
        resp2_parentesco: document.getElementById('resp2_parentesco')?.value || '',
        viagem_tipo: document.getElementById('viagem_tipo').value,
        acompanhado_por: document.getElementById('acompanhado_por').value,
        acomp_nome: document.getElementById('acomp_nome')?.value.trim() || '',
        acomp_doc: document.getElementById('acomp_doc')?.value.trim() || '',
        acomp_parentesco: document.getElementById('acomp_parentesco')?.value.trim() || '',
        destino: document.getElementById('destino').value.trim(),
        data_ida: document.getElementById('data_ida').value,
        data_volta: document.getElementById('data_volta').value,
        cidade_uf_emissao: document.getElementById('cidade_uf_emissao').value.trim(),
        email: document.getElementById('email').value.trim(),
        telefone: document.getElementById('telefone').value.trim()
      };
    }

    var btnPreview = document.getElementById('btnPreview');
    var btnPagar = document.getElementById('btnPagar');
    var previewWrap = document.getElementById('previewWrap');
    var previewBox = document.getElementById('previewBox');

    btnPreview.addEventListener('click', async function () {
      btnPreview.disabled = true; btnPreview.textContent = 'Gerando...';
      try {
        var p = getPayload();
        if (!p.menor_nome || !p.menor_nascimento || !p.resp1_nome || !p.resp1_cpf || !p.destino || !p.data_ida || !p.data_volta || !p.cidade_uf_emissao) {
          alert('Preencha os campos obrigatórios: menor, responsável 1, destino, datas e cidade/UF.'); btnPreview.disabled = false; btnPreview.textContent = 'Gerar prévia'; return;
        }
        if (!isValidCPF(p.resp1_cpf)) { document.getElementById('cpf1Error').style.display = 'block'; btnPreview.disabled = false; btnPreview.textContent = 'Gerar prévia'; return; } else { document.getElementById('cpf1Error').style.display = 'none'; }
        if (p.dois_resps && p.resp2_cpf && !isValidCPF(p.resp2_cpf)) { document.getElementById('cpf2Error').style.display = 'block'; btnPreview.disabled = false; btnPreview.textContent = 'Gerar prévia'; return; } else { document.getElementById('cpf2Error').style.display = 'none'; }

        var r = await fetch('/.netlify/functions/generate-doc', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ payload: p, preview: true }) });
        if (!r.ok) throw new Error('Falha na geração');
        var data = await r.json();
        var out = data.output || data;
        var pr = out.corpo_paragrafos || [];
        var keep = Math.max(1, Math.ceil(pr.length * 0.6));
        var parcial = pr.slice(0, keep).join('\n\n') + '\n\n[...]';
        var saud = out.saudacao || '';
        var fech = out.fechamento || '';
        previewBox.textContent = (saud ? saud + '\n\n' : '') + parcial + (fech ? '\n\n' + fech : '') + '\n\nChecklist: ' + (out.check_list_anexos || []).join('; ');
        previewWrap.style.display = 'block';
        localStorage.setItem('pendingPayload', JSON.stringify(p));
        btnPagar.disabled = false;
      } catch (e) { alert('Erro ao gerar prévia.'); }
      finally { btnPreview.disabled = false; btnPreview.textContent = 'Gerar prévia'; }
    });

    btnPagar.addEventListener('click', async function () {
      try {
        var p = getPayload();
        if (!p.menor_nome || !p.menor_nascimento || !p.resp1_nome || !p.resp1_cpf || !p.destino || !p.data_ida || !p.data_volta || !p.cidade_uf_emissao) { alert('Preencha os campos obrigatórios.'); return; }
        if (!isValidCPF(p.resp1_cpf)) { alert('CPF do responsável 1 inválido.'); return; }
        localStorage.setItem('pendingPayload', JSON.stringify(p));
        btnPagar.disabled = true; btnPagar.textContent = 'Redirecionando...';
        var r = await fetch('/.netlify/functions/mp-checkout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ slug: 'autorizacao-viagem-menor', price: 6.9 }) });
        var d = await r.json();
        if (!r.ok || !d.init_point) throw new Error();
        location.href = d.init_point;
      } catch (e) { alert('Não foi possível abrir o pagamento.'); btnPagar.disabled = false; btnPagar.textContent = 'Gerar documento completo (R$ 6,90)'; }
    });
  </script>
</body>

</html>