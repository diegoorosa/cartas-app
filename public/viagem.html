<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <title>Autorização de Viagem para Menor</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/style.css" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-1021062139"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'AW-1021062139');
    </script>
</head>

<body>
    <div class="container">
        <div class="header">
            <a href="/" class="small" style="text-decoration:none;color:#93c5fd">← Voltar</a>
            <span class="badge">Autorização</span>
        </div>

        <div class="card">
            <h1>Autorização de Viagem para Menor</h1>
            <p class="small">Preencha os dados e gere a autorização em minutos. Documento em .DOC pronto para imprimir e
                assinar.</p>
            <p class="small" style="margin-top:6px;color:#9fb0c7">
                Nacional: certidão de nascimento (original/cópia autenticada) ou RG do menor. Internacional: passaporte
                (RG pode ser aceito no Mercosul, mas recomenda‑se passaporte). CPF não substitui documento de
                identidade.
            </p>

            <div id="formArea">
                <h2>Dados do menor</h2>
                <label class="label">Nome completo do menor</label>
                <input class="input" id="menor_nome" placeholder="Ex.: Ana Souza" />

                <label class="label">Data de nascimento</label>
                <input class="input" id="menor_nasc" placeholder="Ex.: 15/09/2011" />

                <label class="label">Documento do menor (certidão/RG/passaporte)</label>
                <input class="input" id="menor_doc" placeholder="Ex.: Certidão de Nascimento – Livro X, Folha Y" />

                <h2>Viagem</h2>
                <label class="label">Tipo</label>
                <select class="input" id="viagem_tipo">
                    <option value="nacional">Nacional</option>
                    <option value="internacional">Internacional</option>
                </select>
                <label class="label">Destino</label>
                <input class="input" id="destino" placeholder="Ex.: Curitiba/PR ou Lisboa/Portugal" />
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <div>
                        <label class="label">Data de ida</label>
                        <input class="input" id="data_ida" placeholder="Ex.: 20/12/2025" />
                    </div>
                    <div>
                        <label class="label">Data de volta</label>
                        <input class="input" id="data_volta" placeholder="Ex.: 05/01/2026" />
                    </div>
                </div>

                <h2>Acompanhante (se houver)</h2>
                <label class="label">Nome do acompanhante</label>
                <input class="input" id="acomp_nome" placeholder="Ex.: João Silva" />
                <label class="label">Documento do acompanhante</label>
                <input class="input" id="acomp_doc" placeholder="Ex.: RG 1.234.567-8" />
                <label class="label">Parentesco/relação</label>
                <input class="input" id="acomp_parentesco" placeholder="Ex.: Tio, Avó, Responsável legal" />

                <h2>Responsável(veis) que autorizam</h2>
                <label class="label">Responsável 1 — Nome completo</label>
                <input class="input" id="resp1_nome" placeholder="Ex.: Maria Souza" />
                <label class="label">Responsável 1 — CPF</label>
                <input class="input" id="resp1_cpf" placeholder="000.000.000-00" inputmode="numeric" maxlength="14" />

                <label class="label">Responsável 2 — Nome completo (opcional)</label>
                <input class="input" id="resp2_nome" placeholder="Ex.: Carlos Souza" />
                <label class="label">Responsável 2 — CPF (opcional)</label>
                <input class="input" id="resp2_cpf" placeholder="000.000.000-00" inputmode="numeric" maxlength="14" />

                <h2>Outras informações</h2>
                <label class="label">Cidade/UF de emissão</label>
                <input class="input" id="cidade" placeholder="Ex.: Blumenau/SC" />
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <div>
                        <label class="label">E-mail (opcional)</label>
                        <input class="input" id="email" placeholder="Ex.: seu@email.com" />
                    </div>
                    <div>
                        <label class="label">Telefone (opcional)</label>
                        <input class="input" id="telefone" placeholder="Ex.: (47) 9 9999-9999" />
                    </div>
                </div>
                <label class="label">Observações (opcional)</label>
                <textarea class="input" id="observacoes" rows="3"
                    placeholder="Ex.: Autorização válida apenas para o período informado."></textarea>

                <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
                    <button class="btn" id="btnPreview">Gerar prévia</button>
                    <button class="btn btn-outline" id="btnPagar" disabled>Gerar documento completo (R$ 6,90)</button>
                </div>
            </div>

            <div id="previewWrap" style="display:none; margin-top:16px">
                <h2>Prévia do documento</h2>
                <div class="preview" id="previewBox"></div>
                <p class="small" style="margin-top:8px">As últimas linhas foram ocultadas. Na versão completa você
                    poderá copiar, baixar .doc e enviar no WhatsApp.</p>
            </div>
        </div>
    </div>

    <script>
        function getParam(name) { var u = new URL(location.href); return u.searchParams.get(name); }
        function maskCPF(v) { v = (v || '').replace(/\D/g, '').slice(0, 11); v = v.replace(/(\d{3})(\d)/, '$1.$2'); v = v.replace(/(\d{3})(\d)/, '$1.$2'); v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2'); return v; }
        function isValidCPF(cpf) { var s = (cpf || '').replace(/\D/g, ''); if (s.length !== 11) return false; if (/^(\d)\1{10}$/.test(s)) return false; var i, sum = 0, rest; for (i = 1; i <= 9; i++) sum += parseInt(s.substring(i - 1, i)) * (11 - i); rest = (sum * 10) % 11; if (rest === 10 || rest === 11) rest = 0; if (rest !== parseInt(s.substring(9, 10))) return false; sum = 0; for (i = 1; i <= 10; i++) sum += parseInt(s.substring(i - 1, i)) * (12 - i); rest = (sum * 10) % 11; if (rest === 10 || rest === 11) rest = 0; if (rest !== parseInt(s.substring(10, 11))) return false; return true; }

        var r1 = document.getElementById('resp1_cpf');
        var r2 = document.getElementById('resp2_cpf');
        r1.addEventListener('input', function () { r1.value = maskCPF(r1.value); r1.setSelectionRange(r1.value.length, r1.value.length); });
        r2.addEventListener('input', function () { r2.value = maskCPF(r2.value); r2.setSelectionRange(r2.value.length, r2.value.length); });

        function getPayload() {
            r1.value = maskCPF(r1.value);
            r2.value = maskCPF(r2.value);
            return {
                slug: 'autorizacao-viagem-menor',
                tipo: 'autorizacao_viagem',
                entidade: 'Viagem',

                menor_nome: document.getElementById('menor_nome').value.trim(),
                menor_nasc: document.getElementById('menor_nasc').value.trim(),
                menor_doc: document.getElementById('menor_doc').value.trim(),

                viagem_tipo: document.getElementById('viagem_tipo').value,
                destino: document.getElementById('destino').value.trim(),
                data_ida: document.getElementById('data_ida').value.trim(),
                data_volta: document.getElementById('data_volta').value.trim(),

                acomp_nome: document.getElementById('acomp_nome').value.trim(),
                acomp_doc: document.getElementById('acomp_doc').value.trim(),
                acomp_parentesco: document.getElementById('acomp_parentesco').value.trim(),

                resp1_nome: document.getElementById('resp1_nome').value.trim(),
                resp1_cpf: document.getElementById('resp1_cpf').value.trim(),
                resp2_nome: document.getElementById('resp2_nome').value.trim(),
                resp2_cpf: document.getElementById('resp2_cpf').value.trim(),

                cidade_uf: document.getElementById('cidade').value.trim(),
                email: document.getElementById('email').value.trim(),
                telefone: document.getElementById('telefone').value.trim(),
                observacoes: document.getElementById('observacoes').value.trim()
            };
        }

        var btnPreview = document.getElementById('btnPreview');
        var btnPagar = document.getElementById('btnPagar');
        var previewWrap = document.getElementById('previewWrap');
        var previewBox = document.getElementById('previewBox');

        btnPreview.addEventListener('click', function () {
            (async function () {
                btnPreview.disabled = true; btnPreview.textContent = 'Gerando...';
                try {
                    var payload = getPayload();
                    if (!payload.menor_nome || !payload.menor_nasc || !payload.resp1_nome || !payload.resp1_cpf || !payload.destino || !payload.data_ida || !payload.data_volta || !payload.cidade_uf) {
                        alert('Preencha: Menor (nome e nascimento), Responsável 1 (nome e CPF), Destino, Datas e Cidade/UF.');
                        btnPreview.disabled = false; btnPreview.textContent = 'Gerar prévia';
                        return;
                    }
                    if (!isValidCPF(payload.resp1_cpf)) { alert('CPF do Responsável 1 inválido.'); btnPreview.disabled = false; btnPreview.textContent = 'Gerar prévia'; return; }

                    var r = await fetch('/.netlify/functions/generate-doc', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ payload: payload, preview: true })
                    });
                    if (!r.ok) throw new Error('Falha ao gerar');
                    var data = await r.json();
                    var out = data.output || data;
                    var p = out.corpo_paragrafos || [];
                    var keep = Math.max(1, Math.ceil(p.length * 0.6));
                    var parcial = p.slice(0, keep).join('\n\n') + '\n\n[...]';
                    var saud = out.saudacao || '';
                    var fech = out.fechamento || '';
                    previewBox.textContent = (saud ? saud + '\n\n' : '') + parcial + (fech ? '\n\n' + fech : '') + '\n\nChecklist de anexos: ' + (out.check_list_anexos || []).join('; ');
                    previewWrap.style.display = 'block';
                    localStorage.setItem('pendingPayload', JSON.stringify(payload));
                    btnPagar.disabled = false;
                } catch (e) {
                    alert('Erro ao gerar prévia.');
                } finally {
                    btnPreview.disabled = false; btnPreview.textContent = 'Gerar prévia';
                }
            })();
        });

        btnPagar.addEventListener('click', function () {
            (async function () {
                try {
                    var payload = getPayload();
                    if (!payload.menor_nome || !payload.menor_nasc || !payload.resp1_nome || !payload.resp1_cpf || !payload.destino || !payload.data_ida || !payload.data_volta || !payload.cidade_uf) {
                        alert('Preencha os campos obrigatórios.'); return;
                    }
                    if (!isValidCPF(payload.resp1_cpf)) { alert('CPF do Responsável 1 inválido.'); return; }
                    localStorage.setItem('pendingPayload', JSON.stringify(payload));
                    btnPagar.disabled = true; btnPagar.textContent = 'Redirecionando...';

                    var r = await fetch('/.netlify/functions/mp-checkout', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ slug: 'autorizacao-viagem-menor', price: 6.9 })
                    });
                    var data = await r.json();
                    if (!r.ok || !data.init_point) throw new Error('Falha ao abrir pagamento');
                    window.location.href = data.init_point;
                } catch (e) {
                    alert('Não foi possível abrir o pagamento.');
                    btnPagar.disabled = false; btnPagar.textContent = 'Gerar documento completo (R$ 6,90)';
                }
            })();
        });
    </script>
    <script>
        (function () {
            var p = new URL(location.href).searchParams.get('pref');
            if (!p) return;
            var tipo = document.getElementById('viagem_tipo');
            if (!tipo) return;
            if (p === 'nat1' || p === 'nat2' || p === 'terc_nac') tipo.value = 'nacional';
            if (p === 'int1' || p === 'int2' || p === 'terc_int') tipo.value = 'internacional';
        })();
    </script>
</body>

</html>