<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <title>Carta de Bagagem Extraviada ou Danificada | CartasApp</title>
  <meta name="description"
    content="Gere uma carta formal de reclama√ß√£o para bagagem extraviada ou danificada (LATAM, GOL, Azul). Preencha os dados do voo e baixe o PDF/DOC." />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="/theme.js"></script>
  <link rel="stylesheet" href="/style.css" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-1021062139"></script>
  <script src="/gtag.js"></script>
  <script type="text/javascript">
    (function (c, l, a, r, i, t, y) {
      c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
      t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
      y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
    })(window, document, "clarity", "script", "u4x90t35gk");
  </script>

  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>

<body>
  <nav class="navbar">
    <div class="container">
      <div class="navbar-content">
        <a href="/" class="logo">CartasApp</a>
        <div class="nav-actions">
          <button class="btn-theme" onclick="toggleTheme()" aria-label="Alternar tema">
            üåô
          </button>
          <a href="https://wa.me/5547991323024" class="btn btn-secondary btn-sm" target="_blank">
            WhatsApp
          </a>
        </div>
      </div>
    </div>
  </nav>

  <section class="hero" style="padding: 60px 0 40px;">
    <div class="container">
      <div class="hero-content">
        <div class="hero-badge">
          üß≥ Bagagem
        </div>
        <h1 style="font-size: 48px;">Carta ‚Äî Bagagem Extraviada/Danificada</h1>
        <p class="hero-subtitle">
          Preencha os dados do voo e do ocorrido. Gere a carta em .DOC com checklist para envio √† companhia a√©rea.
        </p>
      </div>
    </div>
  </section>

  <section class="section" style="padding-top: 0;">
    <div class="container">
      <div style="max-width: 800px; margin: 0 auto;">
        <div class="card">
          <div id="formArea" data-clarity-mask="true">
            <h2 class="section-title" style="font-size: 24px; margin-bottom: 24px;">Passageiro</h2>

            <label class="label">Nome completo</label>
            <input class="input" id="nome" placeholder="Ex.: Jo√£o Silva" />

            <label class="label">CPF</label>
            <input class="input" id="cpf" placeholder="000.000.000-00" inputmode="numeric" maxlength="14" />

            <label class="label">E-mail</label>
            <input class="input" id="email" placeholder="seu@email.com" />

            <label class="label">Telefone</label>
            <input class="input" id="telefone" placeholder="(00) 00000-0000" />

            <h2 class="section-title" style="font-size: 24px; margin: 32px 0 24px;">Voo</h2>

            <label class="label">Companhia a√©rea</label>
            <input class="input" id="cia" placeholder="Ex.: LATAM, GOL, Azul" />

            <label class="label">N¬∫ do voo</label>
            <input class="input" id="voo" placeholder="Ex.: LA1234" />

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px;">
              <div>
                <label class="label">Data do voo</label>
                <input class="input" id="data_voo" placeholder="DD/MM/AAAA" inputmode="numeric" maxlength="10" />
                <div id="err_data_voo" class="small" style="display:none;color:#fca5a5;margin-top:4px;">Data do voo
                  inv√°lida.</div>
              </div>
              <div>
                <label class="label">Protocolo/PIR</label>
                <input class="input" id="pir" placeholder="Ex.: PIR-ABC123" />
              </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px;">
              <div>
                <label class="label">Origem</label>
                <input class="input" id="origem" placeholder="Ex.: GRU" />
              </div>
              <div>
                <label class="label">Destino</label>
                <input class="input" id="destino" placeholder="Ex.: REC" />
              </div>
            </div>

            <h2 class="section-title" style="font-size: 24px; margin: 32px 0 24px;">Ocorr√™ncia</h2>

            <label class="label">Tipo</label>
            <select class="input" id="status">
              <option value="extraviada">Extraviada</option>
              <option value="danificada">Danificada</option>
            </select>

            <label class="label">Descri√ß√£o dos itens/avarias</label>
            <textarea class="input" id="descricao" rows="3"
              placeholder="Ex.: Mala preta 23kg; roupas e itens pessoais; al√ßa quebrada..."></textarea>

            <label class="label">Despesas emergenciais (se houver)</label>
            <textarea class="input" id="despesas" rows="3"
              placeholder="Ex.: R$ 180,00 em itens de higiene e roupas. Notas anexas."></textarea>

            <h2 class="section-title" style="font-size: 24px; margin: 32px 0 24px;">Local</h2>

            <label class="label">Cidade/UF</label>
            <input class="input" id="cidade_uf" placeholder="Ex.: Blumenau/SC" />

            <div style="margin-top: 32px; transform: scale(0.95); margin-left: -8px;">
              <div class="g-recaptcha" data-sitekey="6Lf-1g8sAAAAAAo1eFRdKSnKIo33F1cBu_sUwNk2" id="recaptcha-widget">
              </div>
            </div>
            <p id="recaptcha-error" class="small" style="display:none; color:var(--accent-error); margin-top:8px;">
              Por favor, marque "N√£o sou um rob√¥" para continuar.
            </p>
            <div style="margin-top:20px; display:flex; gap:12px; flex-wrap:wrap">
              <button class="btn btn-secondary" id="btnPreview">Gerar pr√©via</button>
              <button class="btn btn-primary" id="btnPagar" disabled>Gerar documento completo (R$ 9,90)</button>
            </div>
          </div>

          <div id="previewWrap"
            style="display:none; margin-top:32px; padding-top:32px; border-top:1px solid var(--border);">
            <h2 class="section-title" style="font-size: 24px; margin-bottom: 20px;">Pr√©via do documento</h2>
            <div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:24px;">
              <div id="previewBox"
                style="white-space:pre-wrap;font-family:monospace;font-size:14px;line-height:1.8;color:var(--text-secondary);">
              </div>
            </div>
            <p class="small" style="margin-top:12px;color:var(--text-muted);">
              As √∫ltimas linhas foram ocultadas. Na vers√£o completa voc√™ poder√° copiar, baixar .DOC e enviar no
              WhatsApp.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <p>Este site n√£o presta aconselhamento jur√≠dico. Leia os <a href="/termos.html" class="footer-link">Termos de
            Uso</a>.</p>
      </div>
    </div>
  </footer>

  <script src="/utm.js"></script>

  <script>
    function maskCPF(v) { v = (v || '').replace(/\D/g, '').slice(0, 11); v = v.replace(/(\d{3})(\d)/, '$1.$2'); v = v.replace(/(\d{3})(\d)/, '$1.$2'); v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2'); return v; }
    function isValidCPF(cpf) { var s = (cpf || '').replace(/\D/g, ''); if (s.length !== 11) return false; if (/^(\d)\1{10}$/.test(s)) return false; var i, sum = 0, rest; for (i = 1; i <= 9; i++) sum += parseInt(s.substring(i - 1, i)) * (11 - i); rest = (sum * 10) % 11; if (rest === 10 || rest === 11) rest = 0; if (rest !== parseInt(s.substring(9, 10))) return false; sum = 0; for (i = 1; i <= 10; i++) sum += parseInt(s.substring(i - 1, i)) * (12 - i); rest = (sum * 10) % 11; if (rest === 10 || rest === 11) rest = 0; if (rest !== parseInt(s.substring(10, 11))) return false; return true; }
    function maskDate(v) { v = (v || '').replace(/\D/g, '').slice(0, 8); if (v.length >= 5) v = v.replace(/(\d{2})(\d{2})(\d{1,4})/, '$1/$2/$3'); else if (v.length >= 3) v = v.replace(/(\d{2})(\d{1,2})/, '$1/$2'); return v; }
    function isValidDateBR(s) { if (!/^\d{2}\/\d{2}\/\d{4}$/.test(s || '')) return false; var d = parseInt(s.substr(0, 2), 10), m = parseInt(s.substr(3, 2), 10), y = parseInt(s.substr(6, 4), 10); if (y < 1900 || y > 2100 || m < 1 || m > 12 || d < 1 || d > 31) return false; var md = [31, (y % 4 === 0 && y % 100 !== 0) || y % 400 === 0 ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]; if (d > md[m - 1]) return false; return true; }

    var cpfEl = document.getElementById('cpf');
    cpfEl.addEventListener('input', function () { cpfEl.value = maskCPF(cpfEl.value); });

    // NOVO: Adicionado m√°scara para data_voo
    var dataVooEl = document.getElementById('data_voo');
    if (dataVooEl) { dataVooEl.addEventListener('input', function () { this.value = maskDate(this.value); }); }

    function getPayload() {
      cpfEl.value = maskCPF(cpfEl.value);
      return {
        tipo: 'bagagem',
        slug: 'carta-bagagem',
        nome: document.getElementById('nome').value.trim(),
        cpf: document.getElementById('cpf').value.trim(),
        email: document.getElementById('email').value.trim(),
        telefone: document.getElementById('telefone').value.trim(),
        cia: document.getElementById('cia').value.trim(),
        voo: document.getElementById('voo').value.trim(),
        data_voo: document.getElementById('data_voo').value.trim(),
        pir: document.getElementById('pir').value.trim(),
        origem: document.getElementById('origem').value.trim(),
        destino: document.getElementById('destino').value.trim(),
        status: document.getElementById('status').value,
        descricao: document.getElementById('descricao').value.trim(),
        despesas: document.getElementById('despesas').value.trim(),
        cidade_uf: document.getElementById('cidade_uf').value.trim(),
        utm: (window.LMUTM ? LMUTM.get() : {}) // NOVO: Adicionado UTM
      };
    }

    function validateAll(p) {
      if (!p.nome || !p.cpf || !isValidCPF(p.cpf) || !p.cia || !p.voo || !p.data_voo || !p.origem || !p.destino || !p.status || !p.cidade_uf) return false;
      if (!isValidDateBR(p.data_voo)) { document.getElementById('err_data_voo').style.display = 'block'; return false; } else { document.getElementById('err_data_voo').style.display = 'none'; }
      return true;
    }

    var btnPreview = document.getElementById('btnPreview');
    var btnPagar = document.getElementById('btnPagar');
    var previewWrap = document.getElementById('previewWrap');
    var previewBox = document.getElementById('previewBox');
    var recaptchaError = document.getElementById('recaptcha-error'); // NOVO

    // --- L√ìGICA DO BOT√ÉO DE PR√âVIA (btnPreview) ATUALIZADA ---
    btnPreview.addEventListener('click', async function () {
      btnPreview.disabled = true; btnPreview.textContent = 'Gerando...';
      recaptchaError.style.display = 'none'; // NOVO
      try {
        // --- NOVO: Verifica√ß√£o do reCAPTCHA ---
        var captchaToken = grecaptcha.getResponse();
        if (!captchaToken) {
          recaptchaError.style.display = 'block';
          throw new Error('reCAPTCHA n√£o marcado');
        }
        // --- FIM DA VERIFICA√á√ÉO ---

        var p = getPayload();
        if (!validateAll(p)) {
          alert('Preencha corretamente os campos obrigat√≥rios.');
          throw new Error('Campos inv√°lidos');
        }

        var r = await fetch('/.netlify/functions/generate-doc', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            payload: p,
            preview: true,
            captchaToken: captchaToken // NOVO
          })
        });

        if (!r.ok) {
          var errText = 'Falha ao gerar';
          try { var errData = await r.json(); if (errData.body) errText = errData.body; } catch (e) { }
          if (r.status === 403) errText = 'Falha no reCAPTCHA. Tente novamente.';
          throw new Error(errText);
        }

        var d = await r.json(); var out = d.output || d;
        var pr = out.corpo_paragrafos || []; var keep = Math.max(1, Math.min(2, pr.length));
        var parcial = pr.slice(0, keep).join('\n\n') + '\n\n[...]';
        var saud = out.saudacao || ''; var checklist = out.check_list_anexos || []; var chk2 = checklist.slice(0, 2); if (checklist.length > 2) chk2.push('...');
        previewBox.textContent = (saud ? saud + '\n\n' : '') + parcial + '\n\nChecklist (parcial): ' + chk2.join('; ');
        previewWrap.style.display = 'block';
        localStorage.setItem('pendingPayload', JSON.stringify(p));
        btnPagar.disabled = false;
      } catch (e) {
        if (e.message !== 'Campos inv√°lidos' && e.message !== 'reCAPTCHA n√£o marcado') {
          alert('Erro ao gerar pr√©via: ' + e.message);
        }
      }
      finally {
        btnPreview.disabled = false; btnPreview.textContent = 'Gerar pr√©via';
        try { grecaptcha.reset(); } catch (e) { } // NOVO
      }
    });

    (function () {
      var u = new URL(location.href); var pref = u.searchParams.get('pref'); var cia = u.searchParams.get('cia');
      if (pref === 'extraviada') document.getElementById('status').value = 'extraviada';
      if (pref === 'danificada') document.getElementById('status').value = 'danificada';
      if (cia) document.getElementById('cia').value = cia.toUpperCase();
    })();

    // --- L√ìGICA DO BOT√ÉO DE PAGAR (btnPagar) ATUALIZADA ---
    btnPagar.addEventListener('click', async function () {
      btnPagar.disabled = true; btnPagar.textContent = 'Preparando...';
      recaptchaError.style.display = 'none'; // NOVO
      try {
        // --- NOVO: Verifica√ß√£o do reCAPTCHA ---
        var captchaToken = grecaptcha.getResponse();
        if (!captchaToken) {
          recaptchaError.style.display = 'block';
          throw new Error('reCAPTCHA n√£o marcado');
        }
        // --- FIM DA VERIFICA√á√ÉO ---

        var p = getPayload();
        if (!validateAll(p)) {
          alert('Preencha corretamente os campos obrigat√≥rios.');
          throw new Error('Campos inv√°lidos');
        }
        localStorage.setItem('pendingPayload', JSON.stringify(p));

        var slugStr = 'carta-bagagem';
        var r = await fetch('/.netlify/functions/mp-checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            slug: slugStr,
            payload: p,
            utm: (window.LMUTM ? LMUTM.get() : {}),
            captchaToken: captchaToken // NOVO
          })
        });

        var data = await r.json();
        if (!r.ok) {
          var errText = 'Falha ao criar pagamento';
          try { if (data.body) errText = data.body; } catch (e) { }
          if (r.status === 403) errText = 'Falha no reCAPTCHA. Tente novamente.';
          throw new Error(errText);
        }

        localStorage.setItem('lastOrderId', data.order_id || '');
        if (typeof gtag === 'function') { gtag('event', 'begin_checkout', { value: 9.9, currency: 'BRL', items: [{ item_id: slugStr }] }); } // NOVO: gtag
        showPaymentModal(data.init_point, data.order_id, slugStr);
      } catch (e) {
        if (e.message !== 'Campos inv√°lidos' && e.message !== 'reCAPTCHA n√£o marcado') {
          alert('N√£o foi poss√≠vel abrir o pagamento: ' + e.message);
        }
        btnPagar.disabled = false; btnPagar.textContent = 'Gerar documento completo (R$ 9,90)';
        try { grecaptcha.reset(); } catch (e) { } // NOVO
      }
    });

    // --- L√ìGICA DO MODAL DE PAGAMENTO (showPaymentModal) ATUALIZADA ---
    function showPaymentModal(initPoint, orderId, slug) {
      var isLight = (document.documentElement.getAttribute('data-theme') === 'light');
      var cardBG = isLight ? '#ffffff' : '#111827';
      var cardText = isLight ? '#0f172a' : '#e6eefb';

      var overlay = document.createElement('div');
      overlay.style = 'position:fixed;inset:0;background:rgba(2,6,23,.65);backdrop-filter:blur(6px) saturate(120%);-webkit-backdrop-filter:blur(6px) saturate(120%);z-index:9999;display:flex;align-items:center;justify-content:center';
      overlay.innerHTML = '<div style="background:' + cardBG + ';color:' + cardText + ';border:1px solid var(--border);border-radius:14px;max-width:560px;width:92%;padding:20px;box-shadow:0 18px 44px rgba(0,0,0,.28)">' +
        '<h3 style="margin:0 0 8px">Pagamento</h3>' +
        '<p style="margin:0 0 10px">Abriremos o Mercado Pago em uma nova aba. Ap√≥s pagar, se n√£o redirecionar, volte para esta aba. Assim que o pagamento for confirmado, vamos liberar seu documento automaticamente.</p>' +
        '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">' +
        '<button id="lm-goPay" class="btn">Ir para pagamento</button>' +
        '<button id="lm-copy" class="btn btn-outline">Copiar link de recupera√ß√£o</button>' +
        '<button id="lm-close" class="btn btn-outline">Fechar</button>' +
        '</div>' +
        '<p id="lm-statusPay" class="small" style="margin-top:10px"></p>' +
        '</div>';
      document.body.appendChild(overlay);

      // NOVO: Reseta o reCAPTCHA quando o modal √© fechado
      document.getElementById('lm-close').onclick = function () {
        overlay.remove();
        try { grecaptcha.reset(); } catch (e) { }
      };

      document.getElementById('lm-copy').onclick = function () {
        var link = location.origin + '/recuperar.html?o=' + encodeURIComponent(orderId);
        navigator.clipboard.writeText(link);
        this.textContent = 'Link copiado';
        setTimeout(() => this.textContent = 'Copiar link de recupera√ß√£o', 1200);
      };

      async function docReady() {
        try {
          var r = await fetch('/.netlify/functions/generate-doc', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ payload: { order_id: orderId }, preview: false })
          });
          if (!r.ok) return false;
          var j = await r.json();
          return !!(j && j.output);
        } catch (e) { return false; }
      }

      document.getElementById('lm-goPay').onclick = function () {
        var w = window.open(initPoint, '_blank', 'noopener');
        var st = document.getElementById('lm-statusPay');
        st.textContent = 'Aguardando confirma√ß√£o do pagamento...';
        var start = Date.now();
        var iv = setInterval(async function () {
          try {
            if (await docReady()) {
              clearInterval(iv);
              location.href = '/success.html?o=' + encodeURIComponent(orderId) + '&slug=' + encodeURIComponent(slug || 'documento') + '&s=success';
              return;
            }
            var rr = await fetch('/.netlify/functions/order-status?o=' + encodeURIComponent(orderId));
            var jj = rr.ok ? await rr.json() : null;
            if (jj && jj.status === 'paid') {
              clearInterval(iv);
              location.href = '/success.html?o=' + encodeURIComponent(orderId) + '&slug=' + encodeURIComponent(slug || 'documento') + '&s=success';
              return;
            }
            if (Date.now() - start > 600000) {
              clearInterval(iv);
              st.textContent = 'Ainda n√£o confirmamos. Se voc√™ j√° pagou, use o link copiado para recuperar.';
            }
          } catch (e) { }
        }, 3000);
      };
    }

  </script>
</body>

</html>