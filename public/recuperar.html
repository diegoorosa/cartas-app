<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="/theme.js"></script>
  <link rel="stylesheet" href="/style.css" />
  <title>Seu Documento | CartasApp</title>
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" href="/logo.png" />
  <link rel="apple-touch-icon" href="/logo.png" />

  <script type="text/javascript">
    (function (c, l, a, r, i, t, y) { c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) }; t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i; y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y); })(window, document, "clarity", "script", "u4x90t35gk");
  </script>
</head>

<body>
  <div class="container">
    <div class="card">
      <h1 style="margin-bottom: 8px;">Seu documento est√° pronto</h1>

      <p class="small" style="margin-bottom: 12px; color: var(--text-secondary);">
        Este √© o link permanente para acessar seu documento. Voc√™ pode baixar quantas vezes precisar.
      </p>

      <div class="small"
        style="margin-bottom: 12px; padding: 10px 12px; border-radius: 8px; background: var(--bg-secondary); border: 1px solid var(--border);">
        <strong>Aviso importante:</strong> este √© um <strong>modelo de documento</strong> gerado automaticamente a
        partir das informa√ß√µes que voc√™ informou. O CartasApp n√£o presta assessoria jur√≠dica individual, n√£o analisa
        situa√ß√µes concretas e <strong>n√£o garante que o modelo ser√° aceito</strong> por √≥rg√£os p√∫blicos ou autoridades.
        A responsabilidade pelo uso √© exclusivamente do usu√°rio.
      </div>

      <div id="slug-warning" class="small"
        style="display:none; margin-bottom: 12px; padding: 10px 12px; border-radius: 8px; background: var(--card-hover); border: 1px dashed var(--border);">
      </div>

      <p id="info" class="small" style="margin-bottom: 8px; font-weight:600;">Carregando...</p>

      <div id="doc-wrapper" style="display:none; margin-top:16px;">
        <div
          style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
          <div class="small"
            style="font-weight:600; color:var(--text-primary); display:flex; align-items:center; gap:6px;">
            <span>üìÑ Pr√©-visualiza√ß√£o</span>
          </div>
          <div class="small" style="color:var(--text-muted);">
            Revise os dados. O PDF final ter√° a mesma reda√ß√£o.
          </div>
        </div>

        <div style="border-radius:12px; border:1px solid var(--border); background:var(--bg-secondary); padding:14px;">
          <div id="doc" class="preview" data-clarity-mask="true"
            style="background:#ffffff; border-radius:10px; padding:32px 40px; max-height:520px; overflow:auto; box-shadow:0 10px 25px rgba(15,23,42,0.15); font-family: 'Times New Roman', Georgia, 'serif'; font-size:14px; line-height:1.7; color:#111827;">
          </div>
        </div>
      </div>

      <div id="actions" style="display:none; gap:8px; margin-top:16px; flex-wrap:wrap; align-items:center;">
        <span class="small" style="color:var(--text-secondary); margin-right:8px;">Baixar agora:</span>
        <button class="btn" id="btnCopiar">Copiar texto</button>
        <button class="btn btn-outline" id="btnDoc">Baixar .DOC</button>
        <button class="btn btn-outline" id="btnPdf">Baixar .PDF</button>
        <button class="btn btn-outline" id="btnZap">Enviar no WhatsApp</button>
        <a class="btn btn-outline" id="btnSuporte" target="_blank" rel="noopener">Falar no Suporte</a>
      </div>

      <div id="nav-extra" style="margin-top:24px; padding-top:24px; border-top: 1px solid var(--border);">
        <a href="/" class="btn btn-primary">Voltar ao In√≠cio</a>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <p>Este site n√£o presta aconselhamento jur√≠dico. Leia os <a href="/termos.html" class="footer-link">Termos de
            Uso</a>.</p>
      </div>
    </div>
  </footer>

  <script src="/recovery.js"></script>

  <script>
    // --- FUN√á√ïES HELPER ---
    function qs(n) { var u = new URL(location.href); return u.searchParams.get(n); }
    var orderId = qs('o');

    var info = document.getElementById('info');
    var docBox = document.getElementById('doc');
    var docWrapper = document.getElementById('doc-wrapper');
    var actions = document.getElementById('actions');
    var warningBox = document.getElementById('slug-warning');

    var btnCopiar = document.getElementById('btnCopiar');
    var btnDoc = document.getElementById('btnDoc');
    var btnPdf = document.getElementById('btnPdf');
    var btnZap = document.getElementById('btnZap');
    var btnSuporte = document.getElementById('btnSuporte');

    function renderDocText(out) {
      var partes = [];
      if (out.saudacao) partes.push(out.saudacao);
      var body = out.corpo_paragrafos || [];
      for (var i = 0; i < body.length; i++) partes.push(body[i]);
      if (out.fechamento) partes.push(out.fechamento);
      return partes.join('\n\n');
    }

    function htmlBodyFromText(t) {
      return t.split('\n\n').map(function (p) { return '<p>' + p.replace(/\n/g, '<br/>') + '</p>'; }).join('');
    }

    // --- L√ìGICA DE AVISOS INTELIGENTE ---
    function checkAndShowWarnings(fullText) {
      // Se o texto cont√©m "VIAGEM" e "MENOR", mostramos o aviso espec√≠fico
      // Isso evita depender da URL ter o slug
      if (fullText.toUpperCase().includes('VIAGEM') && (fullText.toUpperCase().includes('MENOR') || fullText.toUpperCase().includes('CRIAN√áA'))) {
        warningBox.style.display = 'block';
        warningBox.innerHTML =
          '<strong>Se este documento for uma autoriza√ß√£o de viagem para menor:</strong>' +
          '<ul style="margin:6px 0 0 18px; padding:0; list-style:disc;">' +
          '<li>trata-se apenas de um <strong>modelo de autoriza√ß√£o</strong>; revise todo o texto antes de assinar ou reconhecer firma;</li>' +
          '<li>para viagens nacionais, em regra √© exigida autoriza√ß√£o com firma reconhecida, mas companhias a√©reas/rodovi√°rias podem impor regras adicionais;</li>' +
          '<li>para viagens internacionais, podem ser exigidos documentos complementares, como autoriza√ß√£o em formul√°rio pr√≥prio, tradu√ß√£o/bil√≠ngue, passaporte v√°lido e at√© <strong>autoriza√ß√£o judicial espec√≠fica</strong> ‚Äî confirme sempre com a Pol√≠cia Federal, a companhia a√©rea e o consulado do pa√≠s de destino;</li>' +
          '<li>em situa√ß√µes de guarda, disputa entre os pais ou d√∫vidas jur√≠dicas, procure a Vara da Inf√¢ncia e Juventude ou um advogado.</li>' +
          '</ul>';
      }
    }

    function attachActions(fullText) {
      var bodyHtml = htmlBodyFromText(fullText);
      var filename = 'Documento_CartasApp';
      if (orderId) filename += '_' + orderId.substring(0, 5);

      btnCopiar.onclick = async function () { try { await navigator.clipboard.writeText(fullText); btnCopiar.textContent = 'Copiado!'; setTimeout(function () { btnCopiar.textContent = 'Copiar texto'; }, 1200); } catch (e) { } };
      btnDoc.onclick = function () { LMRecovery.doc(bodyHtml, filename); };
      btnPdf.onclick = function () { LMRecovery.pdf(bodyHtml, filename); };
      btnZap.onclick = function () { var url = 'https://api.whatsapp.com/send?text=' + encodeURIComponent(fullText); window.open(url, '_blank'); };
      btnSuporte.href = 'https://wa.me/5547988616874?text=' + encodeURIComponent('Oi! Preciso de ajuda. Pedido: ' + (orderId || ''));
    }

    async function loadDocument() {
      if (!orderId) {
        info.textContent = 'Link inv√°lido. Verifique o endere√ßo.';
        info.style.color = 'var(--accent-error)';
        return;
      }

      var attempts = 0;
      while (attempts < 10) {
        try {
          var rs = await fetch('/.netlify/functions/generate-doc', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ payload: { order_id: orderId }, preview: false })
          });

          if (rs.ok) {
            var js = await rs.json();
            if (js && js.output) {
              var fullText = renderDocText(js.output);

              // 1. Esconde o loader
              info.style.display = 'none';

              // 2. Renderiza o documento
              var fullText = renderDocText(js.output);

              // 1. Esconde o loader
              info.style.display = 'none';

              // --- INICIO BLOCO VISUAL PREMIUM ---
              // Tenta detectar o t√≠tulo dinamicamente
              var tituloDoc = "AUTORIZA√á√ÉO DE VIAGEM";
              var textoLower = fullText.toLowerCase();
              if (textoLower.includes("viagem internacional")) tituloDoc += " INTERNACIONAL";
              else if (textoLower.includes("viagem nacional")) tituloDoc += " NACIONAL";
              else if (textoLower.includes("multa") || textoLower.includes("recurso")) tituloDoc = "RECURSO DE MULTA";
              else if (textoLower.includes("reembolso")) tituloDoc = "SOLICITA√á√ÉO DE REEMBOLSO";

              var htmlBonito = `
                  <div style="text-align:center; border-bottom:2px solid #000; padding-bottom:15px; margin-bottom:25px;">
                      <div style="font-size:32px; margin-bottom:5px;">‚öñÔ∏è</div>
                      <h2 style="font-family:'Times New Roman',serif; text-transform:uppercase; margin:0; font-size:18px; color:#000;">${tituloDoc}</h2>
                      <p style="font-family:Arial,sans-serif; font-size:11px; margin:5px 0 0 0; color:#555;">
                          Documento Oficial
                      </p>
                  </div>

                  <div style="font-family:'Times New Roman',serif; font-size:15px; line-height:1.6; text-align:justify; color:#000;">
                      ${fullText.replace(/\n/g, '<br>')}
                  </div>

                  <div style="margin-top:40px; border-top:1px dashed #999; padding-top:10px; text-align:center; font-family:Arial,sans-serif; font-size:10px; color:#777;">
                      Documento gerado via <strong>CartasApp.com.br</strong><br>
                      V√°lido mediante assinatura e reconhecimento de firma.
                  </div>
              `;

              // Renderiza
              docBox.innerHTML = htmlBonito;

              // Estiliza a caixa (caso o CSS n√£o pegue)
              docBox.style.backgroundColor = "#fff";
              docBox.style.padding = "40px";
              docBox.style.border = "1px solid #ccc";
              docBox.style.boxShadow = "0 5px 15px rgba(0,0,0,0.1)";
              // --- FIM BLOCO VISUAL PREMIUM ---

              docWrapper.style.display = 'block';
              actions.style.display = 'flex';

              // 3. Ativa os bot√µes
              attachActions(fullText);

              // 4. Verifica se precisa mostrar o aviso amarelo
              checkAndShowWarnings(fullText);

              return;
              docWrapper.style.display = 'block';
              actions.style.display = 'flex';

              // 3. Ativa os bot√µes
              attachActions(fullText);

              // 4. Verifica se precisa mostrar o aviso amarelo
              checkAndShowWarnings(fullText);

              return;
            }
          }
        } catch (e) { }
        attempts++;
        await new Promise(r => setTimeout(r, 1500));
      }
      info.textContent = 'N√£o encontramos este documento. Aguarde 1 minuto e atualize a p√°gina.';
      info.style.color = 'var(--accent-error)';
    }

    loadDocument();
  </script>
</body>

</html>