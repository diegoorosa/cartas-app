<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />

    <title>Gerar Carta</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="Gere cartas de cancelamento ou reclama√ß√£o para servi√ßos. Pr√©via gr√°tis."
        id="metaDesc" />
    <script src="/theme.js"></script>
    <script src="/utm.js"></script>
    <link rel="stylesheet" href="/style.css" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-1021062139"></script>
    <script src="/gtag.js"></script>
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "u4x90t35gk");
    </script>

    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="/" class="logo">CartasApp</a>
                <div class="nav-actions">
                    <button class="btn-theme" onclick="toggleTheme()" aria-label="Alternar tema">
                        üåô
                    </button>
                    <a href="https://wa.me/5547991323024?text=Oi!%20Tenho%20d%C3%BAvida%20sobre%20meu%20documento"
                        class="btn btn-secondary btn-sm" target="_blank" rel="noopener">
                        WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <section class="hero" style="padding: 60px 0 40px;">
        <div class="container">
            <div class="hero-content">
                <div class="hero-badge">
                    üìÑ Pr√©via gr√°tis
                </div>
                <h1 id="docTitle" style="font-size: 48px;">Gerar Carta</h1>
                <p class="hero-subtitle">
                    Preencha os campos e gere a pr√©via. N√£o √© aconselhamento jur√≠dico.
                </p>
            </div>
        </div>
    </section>

    <section class="section" style="padding-top: 0;">
        <div class="container">
            <div style="max-width: 800px; margin: 0 auto;">
                <div class="card" id="card" data-clarity-mask="true">
                    <div id="formArea">
                        <h2 class="section-title" style="font-size: 24px; margin-bottom: 24px;">Seus dados</h2>

                        <label class="label">Nome completo</label>
                        <input class="input" id="nome" placeholder="Ex.: Jo√£o da Silva" />

                        <label class="label">CPF</label>
                        <input class="input" id="cpf" placeholder="000.000.000-00" inputmode="numeric" maxlength="14" />
                        <div id="cpfError" class="small" style="display:none; color:#fca5a5; margin-top:4px;">
                            CPF inv√°lido. Verifique os d√≠gitos.
                        </div>

                        <label class="label">Cidade/UF</label>
                        <input class="input" id="cidade" placeholder="Ex.: S√£o Paulo/SP" />

                        <label class="label">Unidade/Contrato (opcional)</label>
                        <input class="input" id="contrato" placeholder="Ex.: Unidade Vila Mariana, Contrato 12345" />

                        <label class="label">Motivo ou resumo do caso (opcional)</label>
                        <textarea class="input" id="motivo" rows="3"
                            placeholder="Ex.: cobran√ßa de mensalidade ap√≥s solicita√ß√£o de cancelamento em 10/05"></textarea>

                        <div style="margin-top: 32px; transform: scale(0.95); margin-left: -8px;">
                            <div class="g-recaptcha" data-sitekey="6Lf-1g8sAAAAAAo1eFRdKSnKIo33F1cBu_sUwNk2"
                                id="recaptcha-widget"></div>
                        </div>
                        <p id="recaptcha-error" class="small"
                            style="display:none; color:var(--accent-error); margin-top:8px;">
                            Por favor, marque "N√£o sou um rob√¥" para continuar.
                        </p>
                        <div style="margin-top:20px; display:flex; gap:12px; flex-wrap:wrap">
                            <button class="btn btn-secondary" id="btnPreview">Gerar pr√©via</button>
                            <button class="btn btn-primary" id="btnPagar" disabled>Gerar documento completo (R$
                                9,90)</button>
                        </div>
                    </div>

                    <div id="previewWrap"
                        style="display:none; margin-top:32px; padding-top:32px; border-top:1px solid var(--border);"
                        data-clarity-mask="true">
                        <h2 class="section-title" style="font-size: 24px; margin-bottom: 20px;">Pr√©via do documento</h2>
                        <div
                            style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:24px;">
                            <div id="previewBox"
                                style="white-space:pre-wrap;font-family:monospace;font-size:14px;line-height:1.8;color:var(--text-secondary);">
                            </div>
                        </div>
                        <p class="small" style="margin-top:12px;color:var(--text-muted);">
                            As √∫ltimas linhas foram ocultadas. Na vers√£o completa voc√™ poder√° copiar, baixar .doc e
                            enviar no WhatsApp.
                        </p>
                    </div>
                </div>

                <div style="margin-top:24px;text-align:center;">
                    <p class="small" style="opacity:.9">
                        Este site n√£o presta aconselhamento jur√≠dico. Leia os
                        <a href="/termos.html" style="text-decoration:underline;color:var(--accent-primary)">Termos de
                            Uso</a>.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <p>
                    Este site n√£o presta aconselhamento jur√≠dico. Leia os
                    <a href="/termos.html" class="footer-link">Termos de Uso</a> e nossa
                    <a href="/privacidade.html" class="footer-link">Pol√≠tica de Privacidade</a>.
                </p>
            </div>
        </div>
    </footer>

    <script src="/slugs.js"></script>
    <script src="/recovery.js"></script>
    <script>
        // ======================================================
        // IN√çCIO DO JAVASCRIPT (COM L√ìGICA DE SEO ATUALIZADA)
        // ======================================================

        function getSlug() { var u = new URL(location.href); var qs = u.searchParams.get('slug'); if (qs) return qs; var seg = location.pathname.replace(/\/+$/, '').split('/'); if (seg[1] === 'doc') return decodeURIComponent(seg.slice(2).join('/')); return ''; }
        function getParam(name) { var u = new URL(location.href); return u.searchParams.get(name); }
        LMRecovery.offerRecover();
        var slug = getSlug(); var titleParam = getParam('t'); var cfg = null;
        if (window.SLUGS && slug) { for (var i = 0; i < window.SLUGS.length; i++) { if (window.SLUGS[i].slug === slug) { cfg = window.SLUGS[i]; break; } } }
        var docTitle = document.getElementById('docTitle');
        var formArea = document.getElementById('formArea');
        var md = document.getElementById('metaDesc'); // NOVO: Pega a tag meta description

        if (titleParam) {
            document.title = titleParam + ' | Gerador de Cartas';
            docTitle.textContent = titleParam;
            // NOVO: Define a meta description
            if (md) md.setAttribute('content', 'Gere sua ' + titleParam + ' preenchento seus dados e baixe em .DOC ou PDF por R$ 9,90.');
        }
        else if (cfg) {
            document.title = cfg.title + ' | Gerador de Cartas';
            docTitle.textContent = cfg.title;
            // NOVO: Define a meta description
            if (md) md.setAttribute('content', 'Gere sua ' + cfg.title + ' preenchento seus dados. Modelo de ' + (cfg.tipo || 'documento') + ' para ' + (cfg.brand || 'servi√ßos') + '.');
        }
        else {
            docTitle.textContent = 'Modelo n√£o encontrado';
            formArea.style.display = 'none';
        }

        // --- Vari√°veis de Inputs ---
        var btnPreview = document.getElementById('btnPreview');
        var btnPagar = document.getElementById('btnPagar');
        var previewWrap = document.getElementById('previewWrap');
        var previewBox = document.getElementById('previewBox');
        var nomeInput = document.getElementById('nome');
        var cpfInput = document.getElementById('cpf');
        var cpfError = document.getElementById('cpfError');
        var cidadeInput = document.getElementById('cidade');
        var contratoInput = document.getElementById('contrato');
        var motivoInput = document.getElementById('motivo');
        var recaptchaError = document.getElementById('recaptcha-error'); // NOVO

        // --- Fun√ß√µes de M√°scara e Valida√ß√£o (sem mudan√ßa) ---
        function maskCPF(v) { v = (v || '').replace(/\D/g, '').slice(0, 11); v = v.replace(/(\d{3})(\d)/, '$1.$2'); v = v.replace(/(\d{3})(\d)/, '$1.$2'); v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2'); return v; }
        function isValidCPF(cpf) { var s = (cpf || '').replace(/\D/g, ''); if (s.length !== 11) return false; if (/^(\d)\1{10}$/.test(s)) return false; var sum = 0, rest, i; for (i = 1; i <= 9; i++)sum += parseInt(s.substring(i - 1, i)) * (11 - i); rest = (sum * 10) % 11; if (rest === 10 || rest === 11) rest = 0; if (rest !== parseInt(s.substring(9, 10))) return false; sum = 0; for (i = 1; i <= 10; i++)sum += parseInt(s.substring(i - 1, i)) * (12 - i); rest = (sum * 10) % 11; if (rest === 10 || rest === 11) rest = 0; if (rest !== parseInt(s.substring(10, 11))) return false; return true; }
        function assertCPF() { cpfInput.value = maskCPF(cpfInput.value); var valid = isValidCPF(cpfInput.value); cpfError.style.display = valid ? 'none' : 'block'; if (!valid) cpfInput.focus(); return valid; }
        cpfInput.addEventListener('input', function () { cpfInput.value = maskCPF(cpfInput.value); cpfInput.setSelectionRange(cpfInput.value.length, cpfInput.value.length); });
        cpfInput.addEventListener('blur', assertCPF);
        function getPayload() { cpfInput.value = maskCPF(cpfInput.value); return { slug: slug, tipo: cfg ? cfg.tipo : '', entidade: cfg ? cfg.brand : '', nome: nomeInput.value.trim(), cpf: cpfInput.value.trim(), cidade_uf: cidadeInput.value.trim(), contrato: contratoInput.value.trim(), motivo: motivoInput.value.trim(), utm: window.LMUTM ? LMUTM.get() : {} }; }

        // --- L√ìGICA DO BOT√ÉO DE PR√âVIA (btnPreview) ATUALIZADA ---
        btnPreview.addEventListener('click', function () {
            btnPreview.disabled = true; btnPreview.textContent = 'Gerando...';
            recaptchaError.style.display = 'none'; // NOVO
            (async function () {
                try {
                    // --- NOVO: Verifica√ß√£o do reCAPTCHA ---
                    var captchaToken = grecaptcha.getResponse();
                    if (!captchaToken) {
                        recaptchaError.style.display = 'block';
                        throw new Error('reCAPTCHA n√£o marcado');
                    }
                    // --- FIM DA VERIFICA√á√ÉO ---

                    var payload = getPayload();
                    if (!payload.nome || !payload.cidade_uf || !assertCPF()) {
                        alert('Preencha Nome, Cidade/UF e informe um CPF v√°lido.');
                        throw new Error('Campos inv√°lidos');
                    }

                    var r = await fetch('/.netlify/functions/generate-doc', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            payload: payload,
                            preview: true,
                            captchaToken: captchaToken // NOVO
                        })
                    });

                    if (!r.ok) {
                        var errText = 'Falha ao gerar';
                        try { var errData = await r.json(); if (errData.body) errText = errData.body; } catch (e) { }
                        if (r.status === 403) errText = 'Falha no reCAPTCHA. Tente novamente.';
                        throw new Error(errText);
                    }

                    var data = await r.json(); var out = data.output || data; var p = out.corpo_paragrafos || []; var keep = Math.max(1, Math.ceil(p.length * 0.6)); var parcial = p.slice(0, keep).join('\n\n') + '\n\n[...]'; var saud = out.saudacao || ''; var fech = out.fechamento || '';
                    previewBox.textContent = saud + '\n\n' + parcial + '\n\n' + fech + '\n\nChecklist de anexos: ' + (out.check_list_anexos || []).join('; ');
                    previewWrap.style.display = 'block';
                    localStorage.setItem('pendingPayload', JSON.stringify(payload));
                    gtag('event', 'generate_lead', { method: 'preview', item_id: slug || 'autorizacao' });
                    btnPagar.disabled = false;
                } catch (e) {
                    if (e.message !== 'Campos inv√°lidos' && e.message !== 'reCAPTCHA n√£o marcado') {
                        alert('Erro ao gerar pr√©via: ' + e.message);
                    }
                } finally {
                    btnPreview.disabled = false; btnPreview.textContent = 'Gerar pr√©via';
                    try { grecaptcha.reset(); } catch (e) { } // NOVO
                }
            })();
        });

        // --- L√ìGICA DO BOT√ÉO DE PAGAR (btnPagar) ATUALIZADA ---
        btnPagar.addEventListener('click', function () {
            btnPagar.disabled = true; btnPagar.textContent = 'Preparando...';
            recaptchaError.style.display = 'none'; // NOVO
            (async function () {
                try {
                    // --- NOVO: Verifica√ß√£o do reCAPTCHA ---
                    var captchaToken = grecaptcha.getResponse();
                    if (!captchaToken) {
                        recaptchaError.style.display = 'block';
                        throw new Error('reCAPTCHA n√£o marcado');
                    }
                    // --- FIM DA VERIFICA√á√ÉO ---

                    var payload = getPayload();
                    if (!payload.nome || !payload.cidade_uf || !assertCPF()) {
                        alert('Preencha Nome, Cidade/UF e informe um CPF v√°lido.');
                        throw new Error('Campos inv√°lidos');
                    }
                    localStorage.setItem('pendingPayload', JSON.stringify(payload));

                    var r = await fetch('/.netlify/functions/mp-checkout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            slug: slug,
                            payload: payload,
                            utm: (window.LMUTM ? LMUTM.get() : {}),
                            captchaToken: captchaToken // NOVO
                        })
                    });

                    var data = await r.json();
                    if (!r.ok) {
                        var errText = 'Falha ao criar pagamento';
                        try { if (data.body) errText = data.body; } catch (e) { }
                        if (r.status === 403) errText = 'Falha no reCAPTCHA. Tente novamente.';
                        throw new Error(errText);
                    }

                    localStorage.setItem('lastOrderId', data.order_id || '');
                    if (typeof gtag === 'function') { gtag('event', 'begin_checkout', { value: 9.9, currency: 'BRL', items: [{ item_id: slug || 'autorizacao' }] }); }
                    showPaymentModal(data.init_point, data.order_id, slug);
                } catch (e) {
                    if (e.message !== 'Campos inv√°lidos' && e.message !== 'reCAPTCHA n√£o marcado') {
                        alert('N√£o foi poss√≠vel abrir o pagamento: ' + e.message);
                    }
                    btnPagar.disabled = false; btnPagar.textContent = 'Gerar documento completo (R$ 9,90)';
                    try { grecaptcha.reset(); } catch (e) { } // NOVO
                }
            })();
        });

        // --- L√ìGICA DO MODAL DE PAGAMENTO (showPaymentModal) ATUALIZADA ---
        function showPaymentModal(initPoint, orderId, slug) {
            var isLight = (document.documentElement.getAttribute('data-theme') === 'light');
            var cardBG = isLight ? '#ffffff' : '#111827';
            var cardText = isLight ? '#0f172a' : '#e6eefb';

            var overlay = document.createElement('div');
            overlay.style = 'position:fixed;inset:0;background:rgba(2,6,23,.65);backdrop-filter:blur(6px) saturate(120%);-webkit-backdrop-filter:blur(6px) saturate(1Gpx) saturate(120%);z-index:9999;display:flex;align-items:center;justify-content:center';
            overlay.innerHTML = '<div style="background:' + cardBG + ';color:' + cardText + ';border:1px solid var(--border);border-radius:14px;max-width:560px;width:92%;padding:20px;box-shadow:0 18px 44px rgba(0,0,0,.28)">' +
                '<h3 style="margin:0 0 8px">Pagamento</h3>' +
                '<p style="margin:0 0 10px">Abriremos o Mercado Pago em uma nova aba. Ap√≥s pagar, se n√£o redirecionar, volte para esta aba. Assim que o pagamento for confirmado, vamos liberar seu documento automaticamente.</p>' +
                '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">' +
                '<button id="lm-goPay" class="btn">Ir para pagamento</button>' +
                '<button id="lm-copy" class="btn btn-outline">Copiar link de recupera√ß√£o</button>' +
                '<button id="lm-close" class="btn btn-outline">Fechar</button>' +
                '</div>' +
                '<p id="lm-statusPay" class="small" style="margin-top:10px"></p>' +
                '</div>';
            document.body.appendChild(overlay);

            // NOVO: Reseta o reCAPTCHA quando o modal √© fechado
            document.getElementById('lm-close').onclick = function () {
                overlay.remove();
                try { grecaptcha.reset(); } catch (e) { }
            };

            document.getElementById('lm-copy').onclick = function () {
                var link = location.origin + '/recuperar.html?o=' + encodeURIComponent(orderId);
                navigator.clipboard.writeText(link);
                this.textContent = 'Link copiado';
                setTimeout(() => this.textContent = 'Copiar link de recupera√ß√£o', 1200);
            };

            async function docReady() {
                try {
                    var r = await fetch('/.netlify/functions/generate-doc', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ payload: { order_id: orderId }, preview: false })
                    });
                    if (!r.ok) return false;
                    var j = await r.json();
                    return !!(j && j.output);
                } catch (e) { return false; }
            }

            document.getElementById('lm-goPay').onclick = function () {
                var w = window.open(initPoint, '_blank', 'noopener');
                var st = document.getElementById('lm-statusPay');
                st.textContent = 'Aguardando confirma√ß√£o do pagamento...';
                var start = Date.now();
                var iv = setInterval(async function () {
                    try {
                        if (await docReady()) {
                            clearInterval(iv);
                            location.href = '/success.html?o=' + encodeURIComponent(orderId) + '&slug=' + encodeURIComponent(slug || 'documento') + '&s=success';
                            return;
                        }
                        var rr = await fetch('/.netlify/functions/order-status?o=' + encodeURIComponent(orderId));
                        var jj = rr.ok ? await rr.json() : null;
                        if (jj && jj.status === 'paid') {
                            clearInterval(iv);
                            location.href = '/success.html?o=' + encodeURIComponent(orderId) + '&slug=' + encodeURIComponent(slug || 'documento') + '&s=success';
                            return;
                        }
                        if (Date.now() - start > 600000) {
                            clearInterval(iv);
                            st.textContent = 'Ainda n√£o confirmamos. Se voc√™ j√° pagou, use o link copiado para recuperar.';
                        }
                    } catch (e) { }
                }, 3000);
            };
        }
    </script>
</body>

</html>